# CloudFront + S3 é™çš„ã‚µã‚¤ãƒˆ with Sorryæ©Ÿèƒ½ - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

## ğŸ“‹ æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€CloudFront + S3ã‚’ä½¿ç”¨ã—ãŸé™çš„ã‚µã‚¤ãƒˆã«ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆsorryæ©Ÿèƒ½ï¼‰ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®šç¾©ã—ã¾ã™ã€‚

### ä¸»è¦è¦ä»¶
1. CloudFront + S3ã§é™çš„ã‚µã‚¤ãƒˆã‚’æ§‹ç¯‰
2. AWS WAFã«ã‚ˆã‚‹ä¿è­·
3. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®sorryæ©Ÿèƒ½å®Ÿè£…
4. **ç‰¹å®šIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯é€šå¸¸ã‚µã‚¤ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ï¼ˆsorryãƒ¢ãƒ¼ãƒ‰ä¸­ã§ã‚‚ï¼‰
5. **æ™‚é–“æŒ‡å®šã«ã‚ˆã‚‹sorryãƒšãƒ¼ã‚¸è¡¨ç¤º**ï¼ˆä¾‹ï¼š2025/12/25 00:00-06:00ï¼‰

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ]
    â†“
[Route 53] (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    â†“
[CloudFront Distribution]
    â”œâ”€â”€ AWS WAF WebACL
    â”‚   â””â”€â”€ IP Set (è¨±å¯IPãƒªã‚¹ãƒˆ)
    â”œâ”€â”€ Lambda@Edge (Origin Request)
    â”œâ”€â”€ Origin #1: Main Site S3 Bucket
    â””â”€â”€ Origin #2: Sorry Page S3 Bucket
```

### ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§

#### 1. Amazon S3 Buckets (Ã—2)

**Main Site Bucket**
- ç”¨é€”: é€šå¸¸æ™‚ã®é™çš„ã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- ãƒã‚±ãƒƒãƒˆå: `{project-name}-main-site-{account-id}`
- è¨­å®š:
  - ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼: CloudFront OACã®ã¿è¨±å¯
  - ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹: ãƒ–ãƒ­ãƒƒã‚¯
  - ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°: æœ‰åŠ¹ï¼ˆæ¨å¥¨ï¼‰

**Sorry Page Bucket**
- ç”¨é€”: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®sorryãƒšãƒ¼ã‚¸
- ãƒã‚±ãƒƒãƒˆå: `{project-name}-sorry-page-{account-id}`
- è¨­å®š:
  - ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼: CloudFront OACã®ã¿è¨±å¯
  - ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹: ãƒ–ãƒ­ãƒƒã‚¯
  - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: index.html, style.css, ç”»åƒç­‰

#### 2. Amazon CloudFront Distribution

**åŸºæœ¬è¨­å®š**
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ: `index.html`
- HTTP â†’ HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: æœ‰åŠ¹
- TLS: TLSv1.2ä»¥ä¸Š
- åœ§ç¸®: æœ‰åŠ¹ï¼ˆGzip, Brotliï¼‰

**Origins**

**Origin #1: MainSite**
- Origin Domain: `{main-bucket}.s3.{region}.amazonaws.com`
- Origin Access: Origin Access Control (OAC)
- Origin ID: `MainSiteOrigin`
- ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼: ãªã—

**Origin #2: SorryPage**
- Origin Domain: `{sorry-bucket}.s3.{region}.amazonaws.com`
- Origin Access: Origin Access Control (OAC)
- Origin ID: `SorryPageOrigin`
- ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼: ãªã—

**Cache Behaviors**
- Default Behavior:
  - Path Pattern: `/*`
  - Origin: MainSiteï¼ˆå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆï¼‰
  - Viewer Protocol Policy: Redirect HTTP to HTTPS
  - Allowed HTTP Methods: GET, HEAD, OPTIONS
  - Cache Policy: CachingOptimized
  - Lambda@Edge Associations:
    - Origin Request: MaintenanceRouteré–¢æ•°

#### 3. AWS WAF WebACL

**WebACLè¨­å®š**
- åå‰: `{project-name}-waf-webacl`
- Scope: CloudFrontï¼ˆus-east-1ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³: Allow

**Rule #1: IP Allow List Rule**
- åå‰: `MaintenanceIPAllowRule`
- å„ªå…ˆåº¦: 1
- ã‚¿ã‚¤ãƒ—: IP Set Match
- IP Set: `maintenance-allow-ips`
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: Allow
- æ¡ä»¶: ãƒªã‚¯ã‚¨ã‚¹ãƒˆIPãŒIP Setã«å«ã¾ã‚Œã‚‹å ´åˆ
- ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ : `X-Maintenance-Bypass: true`

**IP Set**
- åå‰: `maintenance-allow-ips`
- Scope: CloudFront
- IP Addresses: ç®¡ç†è€…ãŒæŒ‡å®šï¼ˆæœ€å¤§10,000ã‚¨ãƒ³ãƒˆãƒªï¼‰
- å½¢å¼: IPv4 CIDR, IPv6 CIDR
- ä¾‹: `203.0.113.0/24`, `2001:db8::/32`

#### 4. Lambda@Edge Function

**é–¢æ•°ä»•æ§˜**

**é–¢æ•°å**: `MaintenanceRouterFunction`
**ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **: Node.js 20.x
**ãƒˆãƒªã‚¬ãƒ¼**: Origin Request
**ãƒ¡ãƒ¢ãƒª**: 128 MB
**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 5ç§’

**ç’°å¢ƒå¤‰æ•°ï¼ˆSSM Parameter StoreçµŒç”±ï¼‰**
- `MAINTENANCE_MODE_ENABLED`: `true` / `false`
- `MAINTENANCE_START_TIME`: `2025-12-25T00:00:00+09:00`
- `MAINTENANCE_END_TIME`: `2025-12-25T06:00:00+09:00`
- `TIMEZONE`: `Asia/Tokyo`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**

```typescript
export const handler = async (event) => {
  const request = event.Records[0].cf.request;
  const headers = request.headers;

  // 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ãªã‚‰ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¸
  if (!isMaintenanceModeEnabled()) {
    return routeToMainSite(request);
  }

  // 2. WAFã«ã‚ˆã‚‹IPãƒã‚¤ãƒ‘ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆX-Maintenance-Bypassãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
  if (headers['x-maintenance-bypass']) {
    return routeToMainSite(request);
  }

  // 3. ç¾åœ¨æ™‚åˆ»ãŒæ—¥æœ¬æ™‚é–“ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†…ã‹ãƒã‚§ãƒƒã‚¯
  const now = getCurrentJSTTime();
  const { startTime, endTime } = getMaintenanceWindow();

  if (now >= startTime && now < endTime) {
    // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†… â†’ sorryãƒšãƒ¼ã‚¸ã¸
    return routeToSorryPage(request);
  } else {
    // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å¤– â†’ ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¸
    return routeToMainSite(request);
  }
};

function routeToMainSite(request) {
  request.origin = {
    s3: {
      domainName: 'main-site-bucket.s3.ap-northeast-1.amazonaws.com',
      region: 'ap-northeast-1',
      authMethod: 'origin-access-control',
      path: ''
    }
  };
  return request;
}

function routeToSorryPage(request) {
  request.origin = {
    s3: {
      domainName: 'sorry-page-bucket.s3.ap-northeast-1.amazonaws.com',
      region: 'ap-northeast-1',
      authMethod: 'origin-access-control',
      path: ''
    }
  };
  request.uri = '/index.html'; // å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’sorryãƒšãƒ¼ã‚¸ã¸
  return request;
}
```

**IAM Role**
- ä¿¡é ¼ãƒãƒªã‚·ãƒ¼: `lambda.amazonaws.com`, `edgelambda.amazonaws.com`
- ç®¡ç†ãƒãƒªã‚·ãƒ¼:
  - `AWSLambdaBasicExecutionRole`
  - ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ï¼ˆSSM Parameter Storeèª­ã¿å–ã‚Šæ¨©é™ï¼‰

#### 5. AWS Systems Manager Parameter Store

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§**

```
/cloudfront-sorry/maintenance-mode-enabled
  Type: String
  Value: "true" | "false"

/cloudfront-sorry/maintenance-start-time
  Type: String
  Value: "2025-12-25T00:00:00+09:00"

/cloudfront-sorry/maintenance-end-time
  Type: String
  Value: "2025-12-25T06:00:00+09:00"
```

---

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

### ã‚±ãƒ¼ã‚¹1: é€šå¸¸æ™‚ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹ï¼‰

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  â†’ CloudFront
  â†’ WAFï¼ˆå…¨ã¦è¨±å¯ï¼‰
  â†’ Lambda@Edgeï¼ˆOrigin Requestï¼‰
    - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: OFF
    - åˆ¤å®š: MainSiteã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  â†’ S3 Main Bucket
  â†’ CloudFrontï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é…ä¿¡
```

### ã‚±ãƒ¼ã‚¹2: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†… + ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆIP: 1.2.3.4ï¼‰
  â†’ CloudFront
  â†’ WAF
    - IP Setãƒãƒƒãƒ: ãªã—
    - ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ : ãªã—
  â†’ Lambda@Edgeï¼ˆOrigin Requestï¼‰
    - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: ON
    - ç¾åœ¨æ™‚åˆ»: 2025-12-25 03:00 JSTï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†…ï¼‰
    - IPãƒã‚¤ãƒ‘ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼: ãªã—
    - åˆ¤å®š: SorryPageã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  â†’ S3 Sorry Bucket
  â†’ CloudFrontï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  â†’ sorryãƒšãƒ¼ã‚¸é…ä¿¡
```

### ã‚±ãƒ¼ã‚¹3: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†… + è¨±å¯IPãƒ¦ãƒ¼ã‚¶ãƒ¼

```
ç®¡ç†è€…ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆIP: 203.0.113.10ï¼‰
  â†’ CloudFront
  â†’ WAF
    - IP Setãƒãƒƒãƒ: ã‚ã‚Šï¼ˆ203.0.113.0/24ã«å«ã¾ã‚Œã‚‹ï¼‰
    - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: Allow
    - ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ : X-Maintenance-Bypass: true
  â†’ Lambda@Edgeï¼ˆOrigin Requestï¼‰
    - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: ON
    - ç¾åœ¨æ™‚åˆ»: 2025-12-25 03:00 JSTï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†…ï¼‰
    - IPãƒã‚¤ãƒ‘ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚ã‚Š âœ…
    - åˆ¤å®š: MainSiteã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  â†’ S3 Main Bucket
  â†’ CloudFrontï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  â†’ é€šå¸¸ã‚µã‚¤ãƒˆé…ä¿¡
```

### ã‚±ãƒ¼ã‚¹4: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å¤–

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  â†’ CloudFront
  â†’ WAFï¼ˆå…¨ã¦è¨±å¯ï¼‰
  â†’ Lambda@Edgeï¼ˆOrigin Requestï¼‰
    - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰: ON
    - ç¾åœ¨æ™‚åˆ»: 2025-12-25 07:00 JSTï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å¤–ï¼‰
    - åˆ¤å®š: MainSiteã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  â†’ S3 Main Bucket
  â†’ CloudFrontï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  â†’ é€šå¸¸ã‚µã‚¤ãƒˆé…ä¿¡
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. S3ãƒã‚±ãƒƒãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯æœ‰åŠ¹
- âœ… CloudFront OACã®ã¿ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
- âœ… ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã§å³æ ¼ãªåˆ¶é™
- âœ… TLSé€šä¿¡å¼·åˆ¶ï¼ˆCloudFrontçµŒç”±ã®ã¿ï¼‰

### 2. CloudFront ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… HTTPSå¼·åˆ¶ï¼ˆHTTP â†’ HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
- âœ… TLS 1.2ä»¥ä¸Šã®ã¿è¨±å¯
- âœ… AWS WAFçµ±åˆ
- âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢

### 3. Lambda@Edge ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆIAMãƒ­ãƒ¼ãƒ«ï¼‰
- âœ… CloudWatch Logsã¸ã®ãƒ­ã‚°å‡ºåŠ›
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ5ç§’ï¼‰
- âœ… Parameter Storeã‹ã‚‰ã®å®‰å…¨ãªè¨­å®šå–å¾—

### 4. AWS WAF ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… IPè¨±å¯ãƒªã‚¹ãƒˆã®ç®¡ç†
- âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- âœ… ãƒ­ã‚°è¨˜éŒ²æœ‰åŠ¹åŒ–
- âœ… CloudWatch ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–

---

## ğŸ’° ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

### ä¸»è¦ã‚³ã‚¹ãƒˆè¦ç´ 

**CloudFront**
- ãƒ‡ãƒ¼ã‚¿è»¢é€: æœ€åˆã®10TB $0.114/GBï¼ˆap-northeast-1ï¼‰
- HTTPSãƒªã‚¯ã‚¨ã‚¹ãƒˆ: $0.0120/10,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- Lambda@Edgeå®Ÿè¡Œ: $0.00000625125/128MBãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**S3**
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: $0.025/GBï¼ˆStandardï¼‰
- GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ: $0.00037/1,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**AWS WAF**
- WebACL: $5.00/æœˆ
- ãƒ«ãƒ¼ãƒ«: $1.00/æœˆ/ãƒ«ãƒ¼ãƒ«
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: $0.60/1M ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**Lambda@Edge**
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: $0.60/1M ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- å®Ÿè¡Œæ™‚é–“: $0.00000625125/128MB-ç§’

**æœˆé–“è¦‹ç©ã‚‚ã‚Šä¾‹**ï¼ˆæœˆé–“100ä¸‡PVæƒ³å®šï¼‰
- CloudFront: ç´„ $15-20
- S3: ç´„ $1-2
- AWS WAF: ç´„ $6-7
- Lambda@Edge: ç´„ $1-2
- **åˆè¨ˆ: ç´„ $23-31/æœˆ**

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**Main Siteï¼ˆé€šå¸¸æ™‚ï¼‰**
- Cache-Control: `max-age=3600, public`ï¼ˆ1æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- HTML: çŸ­ã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ5åˆ†ï¼‰
- é™çš„ã‚¢ã‚»ãƒƒãƒˆï¼ˆCSS/JS/ç”»åƒï¼‰: é•·ã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ1æ—¥ä»¥ä¸Šï¼‰

**Sorry Pageï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ï¼‰**
- Cache-Control: `max-age=60, public`ï¼ˆ1åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- ç†ç”±: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çµ‚äº†å¾Œã®è¿…é€Ÿãªåˆ‡ã‚Šæ›¿ãˆ

### Lambda@Edgeæœ€é©åŒ–
- å‡¦ç†æ™‚é–“: é€šå¸¸ < 50ms
- ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ­ã‚¸ãƒƒã‚¯ã€è»½é‡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥: Lambdaå†…ã§Parameter Storeå€¤ã‚’1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### CloudFrontæœ€é©åŒ–
- åœ§ç¸®: Gzip, Brotliæœ‰åŠ¹åŒ–
- HTTP/2, HTTP/3å¯¾å¿œ
- Origin Shield: å¤§è¦æ¨¡ã‚µã‚¤ãƒˆã®å ´åˆæ¤œè¨

---

## ğŸ”§ é‹ç”¨æ‰‹é †

### ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–æ‰‹é †

```bash
# 1. Parameter Storeã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã‚’è¨­å®š
aws ssm put-parameter \
  --name "/cloudfront-sorry/maintenance-start-time" \
  --value "2025-12-25T00:00:00+09:00" \
  --type String \
  --overwrite

aws ssm put-parameter \
  --name "/cloudfront-sorry/maintenance-end-time" \
  --value "2025-12-25T06:00:00+09:00" \
  --type String \
  --overwrite

# 2. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
aws ssm put-parameter \
  --name "/cloudfront-sorry/maintenance-mode-enabled" \
  --value "true" \
  --type String \
  --overwrite

# 3. CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆå³åº§ã«åæ˜ ï¼‰
aws cloudfront create-invalidation \
  --distribution-id XXXXXXXXXXXXX \
  --paths "/*"
```

### è¨±å¯IPè¿½åŠ æ‰‹é †

```bash
# WAF IP Setã¸ã®è¿½åŠ 
aws wafv2 update-ip-set \
  --scope CLOUDFRONT \
  --id <ip-set-id> \
  --addresses "203.0.113.0/24" "198.51.100.10/32" \
  --lock-token <lock-token>
```

### ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ
- CloudWatch Logs: Lambda@Edgeå®Ÿè¡Œãƒ­ã‚°
- CloudWatch Metrics: CloudFrontãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆ
- WAF Logs: ãƒ–ãƒ­ãƒƒã‚¯/è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è¨˜éŒ²
- X-Ray: Lambda@Edgeå®Ÿè¡Œãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### Phase 1: ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
1. S3ãƒã‚±ãƒƒãƒˆä½œæˆï¼ˆMain + Sorryï¼‰
2. CloudFront Distributionä½œæˆï¼ˆåˆæœŸè¨­å®šï¼‰
3. AWS WAF WebACLä½œæˆ
4. Parameter Storeè¨­å®š

### Phase 2: Lambda@Edge ãƒ‡ãƒ—ãƒ­ã‚¤
1. Lambdaé–¢æ•°ä½œæˆï¼ˆus-east-1ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
2. IAMãƒ­ãƒ¼ãƒ«è¨­å®š
3. CloudFront Distributionã¸é–¢æ•°ã‚¢ã‚¿ãƒƒãƒ
4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### Phase 3: å‹•ä½œç¢ºèª
1. é€šå¸¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
2. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–ãƒ†ã‚¹ãƒˆ
3. IPè¨±å¯ãƒªã‚¹ãƒˆãƒ†ã‚¹ãƒˆ
4. æ™‚é–“ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

### Phase 4: æœ¬ç•ªå…¬é–‹
1. DNSè¨­å®šï¼ˆRoute 53ï¼‰
2. SSLè¨¼æ˜æ›¸è¨­å®šï¼ˆACMï¼‰
3. ç›£è¦–è¨­å®š
4. é‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

---

## ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ§‹ç¯‰å‰ãƒã‚§ãƒƒã‚¯
- [ ] AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæº–å‚™å®Œäº†
- [ ] ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é¸å®šï¼ˆap-northeast-1æ¨å¥¨ï¼‰
- [ ] ãƒ‰ãƒ¡ã‚¤ãƒ³åæ±ºå®š
- [ ] è¨±å¯IPãƒªã‚¹ãƒˆæº–å‚™

### æ§‹ç¯‰å¾Œãƒã‚§ãƒƒã‚¯
- [ ] S3ãƒã‚±ãƒƒãƒˆãŒãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®š
- [ ] CloudFrontçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] WAF WebACLé©ç”¨ç¢ºèª
- [ ] Lambda@Edgeæ­£å¸¸å‹•ä½œç¢ºèª
- [ ] sorryãƒšãƒ¼ã‚¸è¡¨ç¤ºç¢ºèª
- [ ] IPè¨±å¯ãƒªã‚¹ãƒˆå‹•ä½œç¢ºèª
- [ ] æ™‚é–“ãƒ™ãƒ¼ã‚¹åˆ‡ã‚Šæ›¿ãˆå‹•ä½œç¢ºèª
- [ ] SSLè¨¼æ˜æ›¸æœ‰åŠ¹ç¢ºèª
- [ ] ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šå®Œäº†

---

## ğŸ¯ æˆåŠŸåŸºæº–

1. âœ… é€šå¸¸æ™‚ã«é™çš„ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹
2. âœ… ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹æ™‚ã«sorryãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. âœ… è¨±å¯IPã‹ã‚‰ã¯å¸¸ã«ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
4. âœ… æŒ‡å®šæ™‚é–“ã®ã¿sorryãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
5. âœ… æ™‚é–“å¤–ã¯è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã«æˆ»ã‚‹
6. âœ… CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒé©åˆ‡ã«å‹•ä½œ
7. âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãŒ1ç§’ä»¥å†…
8. âœ… é‹ç”¨æ‹…å½“è€…ãŒè¨­å®šå¤‰æ›´å¯èƒ½

---

## ğŸ” Lambda@Edge å¿…è¦æ€§åˆ†æï¼šæ™‚é–“æŒ‡å®šæœ‰ç„¡ã«ã‚ˆã‚‹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ

### ğŸ“‹ åˆ†ææ¦‚è¦

CloudFront + S3 é™çš„ã‚µã‚¤ãƒˆã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹éš›ã€Lambda@Edge ã®å¿…è¦æ€§ã¯**æ™‚é–“æŒ‡å®šã®æœ‰ç„¡**ã«ã‚ˆã£ã¦å¤§ããç•°ãªã‚Šã¾ã™ã€‚æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€è¦ä»¶åˆ¥ã®æœ€é©ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¯”è¼ƒåˆ†æã—ã¾ã™ã€‚

### ğŸ¯ ä¸»è¦ãªç–‘å•

1. **æ™‚é–“æŒ‡å®šã‚’è¡Œã†ãŸã‚ã«ã¯ Lambda@Edge ãŒå¿…è¦ã‹ï¼Ÿ**
2. **æ™‚é–“æŒ‡å®šãŒãªã‘ã‚Œã° Lambda@Edge ã¯ä¸è¦ã‹ï¼Ÿ**

### èƒŒæ™¯

- ç¾åœ¨ã®å®Ÿè£…ã§ã¯ Lambda@Edge ã‚’ä½¿ç”¨ã—ã¦æ™‚é–“å¸¯ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã‚’å®Ÿè£…
- Lambda@Edge ã®ã‚³ã‚¹ãƒˆã¯æœˆé¡ $5.20/100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- ã‚ˆã‚Šè»½é‡ãª CloudFront Functions ã¯æœˆé¡ $0.87/100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆç´„6å€å®‰ã„ï¼‰
- è¦ä»¶ã«å¿œã˜ãŸæœ€é©ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¸æŠãŒå¿…è¦

### âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†é¡

| è¦ä»¶ | æ¨å¥¨å®Ÿè£… | Lambda@Edge å¿…è¦æ€§ | æœˆé¡ã‚³ã‚¹ãƒˆ (100ä¸‡req) |
|------|---------|-------------------|---------------------|
| ğŸ• æ™‚é–“å¸¯ãƒ™ãƒ¼ã‚¹è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ | Lambda@Edge | âœ… **å¿…é ˆ** | $5.20 |
| ğŸ” IP ãƒã‚¤ãƒ‘ã‚¹ + å³åº§åˆ‡ã‚Šæ›¿ãˆ | CloudFront Functions | ä¸è¦ | $0.87 |
| ğŸ“Š Parameter Store é€£æº | Lambda@Edge | âœ… **å¿…é ˆ** | $5.20 |
| ğŸšï¸ ãƒ•ãƒ©ã‚°ON/OFF ã®ã¿ | CloudFront Functions | ä¸è¦ | $0.87 |
| ğŸ’¾ DynamoDB é€£æº | Lambda@Edge | âœ… **å¿…é ˆ** | $5.20 |
| ğŸ”„ å¹´æ•°å›ã®æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆ | æ‰‹å‹• Origin å¤‰æ›´ | ä¸è¦ | $0 |

### ğŸ” è©³ç´°å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: Lambda@Edge å®Ÿè£…ï¼ˆæ™‚é–“æŒ‡å®š**å¿…è¦**ï¼‰

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**
- æ¯æ—¥æ±ºã¾ã£ãŸæ™‚é–“å¸¯ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
- ä¾‹: æ¯æ—¥æ·±å¤œ0æ™‚ã€œ6æ™‚ã¯è‡ªå‹•çš„ã«Sorryãƒšãƒ¼ã‚¸è¡¨ç¤º
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå‹•çš„ã«å¤‰åŒ–ã™ã‚‹

**å®Ÿè£…ä¾‹**

```javascript
// lambda/maintenance-router.js
exports.handler = async (event) => {
  const request = event.Records[0].cf.request;
  const headers = request.headers;

  // 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°å–å¾—ï¼ˆSSM Parameter Storeï¼‰
  const maintenanceEnabled = process.env.MAINTENANCE_MODE_ENABLED === 'true';

  // 2. ãƒã‚¤ãƒ‘ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆWAF IP Set ã‹ã‚‰ã®æ³¨å…¥ï¼‰
  if (headers['x-maintenance-bypass'] &&
      headers['x-maintenance-bypass'][0].value === 'true') {
    // è¨±å¯IPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ â†’ Main Site ã¸
    request.origin = {
      s3: {
        domainName: process.env.MAIN_SITE_BUCKET,
        region: 'ap-northeast-1',
        authMethod: 'origin-access-control',
        path: '',
      }
    };
    return request;
  }

  // 3. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ â†’ Main Site ã¸
  if (!maintenanceEnabled) {
    request.origin = {
      s3: {
        domainName: process.env.MAIN_SITE_BUCKET,
        region: 'ap-northeast-1',
        authMethod: 'origin-access-control',
        path: '',
      }
    };
    return request;
  }

  // 4. æ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯ï¼ˆJSTï¼‰
  const now = new Date();
  const jstNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));

  const startTime = new Date(process.env.MAINTENANCE_START_TIME);
  const endTime = new Date(process.env.MAINTENANCE_END_TIME);

  // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å¤– â†’ Main Site ã¸
  if (jstNow < startTime || jstNow > endTime) {
    request.origin = {
      s3: {
        domainName: process.env.MAIN_SITE_BUCKET,
        region: 'ap-northeast-1',
        authMethod: 'origin-access-control',
        path: '',
      }
    };
    return request;
  }

  // 5. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“å†… â†’ Sorry Page ã¸
  request.origin = {
    s3: {
      domainName: process.env.SORRY_PAGE_BUCKET,
      region: 'ap-northeast-1',
      authMethod: 'origin-access-control',
      path: '',
    }
  };

  return request;
};
```

**ãƒ¡ãƒªãƒƒãƒˆ**
- âœ… æ™‚é–“å¸¯ãƒ™ãƒ¼ã‚¹ã®å®Œå…¨è‡ªå‹•åˆ¶å¾¡
- âœ… Parameter Store ã¨ã®é€£æºå¯èƒ½
- âœ… IP ãƒã‚¤ãƒ‘ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…å¯èƒ½
- âœ… è¤‡é›‘ãªæ¡ä»¶åˆ¤å®šãŒå¯èƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
- âš ï¸ ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆ$5.20/100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- âš ï¸ 5ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶é™
- âš ï¸ us-east-1 ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤å¿…é ˆ

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: CloudFront Functions å®Ÿè£…ï¼ˆæ™‚é–“æŒ‡å®š**ä¸è¦**ï¼‰

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**
- æ‰‹å‹•ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
- æ™‚é–“å¸¯ã«ã‚ˆã‚‹è‡ªå‹•åˆ¶å¾¡ã¯ä¸è¦
- IP ãƒã‚¤ãƒ‘ã‚¹æ©Ÿèƒ½ã¯ç¶­æŒã—ãŸã„
- ã‚³ã‚¹ãƒˆå‰Šæ¸›å„ªå…ˆ

**å®Ÿè£…ä¾‹**

```javascript
// CloudFront Function (Viewer Request)
function handler(event) {
    var request = event.request;
    var headers = request.headers;

    // 1. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰
    // ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å¤‰æ›´ã—ã¦åæ˜ 
    var maintenanceMode = false; // â† ã“ã“ã‚’ true/false ã«å¤‰æ›´

    // 2. ãƒã‚¤ãƒ‘ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆWAF IP Set ã‹ã‚‰ã®æ³¨å…¥ï¼‰
    if (headers['x-maintenance-bypass'] &&
        headers['x-maintenance-bypass'].value === 'true') {
        return request; // é€šå¸¸ã‚µã‚¤ãƒˆã¸
    }

    // 3. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ Sorry ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if (maintenanceMode) {
        return {
            statusCode: 302,
            statusDescription: 'Found',
            headers: {
                'location': { value: '/maintenance.html' }
            }
        };
    }

    return request;
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**
- âœ… Lambda@Edge ã‚ˆã‚Šç´„6å€å®‰ã„ï¼ˆ$0.87 vs $5.20ï¼‰
- âœ… ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒä½ã„ï¼ˆ<1ms vs æ•°åmsï¼‰
- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé€Ÿã„ï¼ˆæ•°ç§’ã§åæ˜ ï¼‰
- âœ… IP ãƒã‚¤ãƒ‘ã‚¹æ©Ÿèƒ½ç¶­æŒå¯èƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
- âš ï¸ å¤–éƒ¨APIå‘¼ã³å‡ºã—ä¸å¯ï¼ˆParameter Store èª­ã‚ãªã„ï¼‰
- âš ï¸ æ™‚é–“åˆ¤å®šä¸å¯ï¼ˆDate ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ¶é™ã‚ã‚Šï¼‰
- âš ï¸ ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚º < 10KBï¼ˆLambda@Edge ã¯ 1MBï¼‰
- âš ï¸ å®Ÿè¡Œæ™‚é–“ < 1msï¼ˆLambda@Edge ã¯ 5ç§’ï¼‰

**CloudFront Functions ã®åˆ¶ç´„**

| æ©Ÿèƒ½ | CloudFront Functions | Lambda@Edge |
|------|---------------------|-------------|
| å®Ÿè¡Œæ™‚é–“ | < 1ms | 5ç§’ |
| ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚º | < 10KB | 1MBï¼ˆåœ§ç¸®å¾Œï¼‰ |
| ãƒ¡ãƒ¢ãƒª | 2MB | 128MBã€œ10GB |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| ç’°å¢ƒå¤‰æ•° | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| Parameter Store | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | âš ï¸ åˆ¶é™ã‚ã‚Š | âœ… å®Œå…¨å¯¾å¿œ |

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ‰‹å‹• Origin åˆ‡ã‚Šæ›¿ãˆï¼ˆæ™‚é–“æŒ‡å®š**ä¸è¦** + ã‚³ã‚¹ãƒˆæœ€å„ªå…ˆï¼‰

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¹´1ã€œ2å›ç¨‹åº¦
- IP ãƒã‚¤ãƒ‘ã‚¹ä¸è¦
- è¨ˆç”»çš„ãªé•·æ™‚é–“ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ï¼ˆ2ã€œ3æ™‚é–“ä»¥ä¸Šï¼‰
- ã‚³ã‚¹ãƒˆæœ€å„ªå…ˆ

**å®Ÿè£…æ‰‹é †**

```bash
# ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–‹å§‹ï¼ˆæ‰‹å‹•ï¼‰
# 1. CloudFront Distribution ã® Origin ã‚’ Sorry Page ã«å¤‰æ›´
aws cloudfront get-distribution-config \
  --id E1234EXAMPLE > distribution-config.json

# 2. distribution-config.json ã‚’ç·¨é›†ï¼ˆOrigin ã‚’å¤‰æ›´ï¼‰
# "DomainName": "cloudfront-main-site.s3.amazonaws.com"
#   â†“
# "DomainName": "cloudfront-sorry-page.s3.amazonaws.com"

# 3. Distribution æ›´æ–°
aws cloudfront update-distribution \
  --id E1234EXAMPLE \
  --distribution-config file://distribution-config.json \
  --if-match ETVABCEXAMPLE

# 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
aws cloudfront create-invalidation \
  --distribution-id E1234EXAMPLE \
  --paths "/*"

# âš ï¸ åæ˜ ã« 15ã€œ30åˆ†ã‹ã‹ã‚‹
```

**ãƒ¡ãƒªãƒƒãƒˆ**
- âœ… Lambda/Function ã‚³ã‚¹ãƒˆä¸è¦
- âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- âœ… é•·æœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã«é©ã—ã¦ã„ã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
- âš ï¸ CloudFront è¨­å®šã®åæ˜ ã« 15ã€œ30åˆ†ã‹ã‹ã‚‹
- âš ï¸ æ‰‹å‹•ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒŸã‚¹ã®ãƒªã‚¹ã‚¯
- âš ï¸ IP ãƒã‚¤ãƒ‘ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…ãŒå›°é›£
- âš ï¸ å³åº§ã®åˆ‡ã‚Šæ›¿ãˆãŒä¸å¯èƒ½

### ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒãƒãƒˆãƒªã‚¯ã‚¹

#### æ©Ÿèƒ½æ¯”è¼ƒ

| è¦ä»¶ | Lambda@Edge | CloudFront Functions | æ‰‹å‹• Origin åˆ‡ã‚Šæ›¿ãˆ |
|------|------------|---------------------|-------------------|
| ğŸ• **æ™‚é–“å¸¯ãƒ™ãƒ¼ã‚¹åˆ¶å¾¡** | âœ… å¯èƒ½ | âŒ ä¸å¯ | âŒ ä¸å¯ |
| ğŸ” **IP ãƒã‚¤ãƒ‘ã‚¹** | âœ… å¯èƒ½ | âœ… å¯èƒ½ | âš ï¸ å›°é›£ |
| âš¡ **å³åº§åˆ‡ã‚Šæ›¿ãˆ** | âœ… å¯èƒ½ï¼ˆæ•°ç§’ï¼‰ | âœ… å¯èƒ½ï¼ˆæ•°ç§’ï¼‰ | âŒ ä¸å¯ï¼ˆ15ã€œ30åˆ†ï¼‰ |
| ğŸ“Š **Parameter Store é€£æº** | âœ… å¯èƒ½ | âŒ ä¸å¯ | âŒ ä¸å¯ |
| ğŸ’¾ **DynamoDB é€£æº** | âœ… å¯èƒ½ | âŒ ä¸å¯ | âŒ ä¸å¯ |
| ğŸšï¸ **ãƒ•ãƒ©ã‚° ON/OFF** | âœ… å¯èƒ½ | âœ… å¯èƒ½ | âœ… å¯èƒ½ |
| ğŸ“± **User-Agent åˆ¤å®š** | âœ… å¯èƒ½ | âœ… å¯èƒ½ | âŒ ä¸å¯ |
| ğŸŒ **åœ°ç†çš„æ¡ä»¶åˆ¤å®š** | âœ… å¯èƒ½ | âš ï¸ åˆ¶é™ã‚ã‚Š | âŒ ä¸å¯ |

#### ã‚³ã‚¹ãƒˆæ¯”è¼ƒï¼ˆæœˆé–“100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

| ã‚³ã‚¹ãƒˆé …ç›® | Lambda@Edge | CloudFront Functions | æ‰‹å‹• Origin åˆ‡ã‚Šæ›¿ãˆ |
|-----------|------------|---------------------|-------------------|
| Lambda/Function | $5.20 | $0.87 | $0 |
| CloudFront | $11.50 | $11.50 | $11.50 |
| S3 | $3.00 | $3.00 | $3.00 |
| WAF | $1.00 | $1.00 | $0 (ä¸è¦) |
| **åˆè¨ˆ** | **$20.70** | **$16.37** | **$14.50** |
| **å‰Šæ¸›é¡** | - | **$4.33 (21%)** | **$6.20 (30%)** |

#### é‹ç”¨è² è·æ¯”è¼ƒ

| é‹ç”¨é …ç›® | Lambda@Edge | CloudFront Functions | æ‰‹å‹• Origin åˆ‡ã‚Šæ›¿ãˆ |
|---------|------------|---------------------|-------------------|
| ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“ | 5ã€œ10åˆ† | æ•°ç§’ | 15ã€œ30åˆ† |
| è¨­å®šå¤‰æ›´ | Parameter Store | ã‚³ãƒ¼ãƒ‰å¤‰æ›´ + ãƒ‡ãƒ—ãƒ­ã‚¤ | CloudFrontè¨­å®šå¤‰æ›´ |
| åˆ‡ã‚Šæ›¿ãˆæ‰‹é † | è‡ªå‹• or CLI 1è¡Œ | ã‚³ãƒ¼ãƒ‰å¤‰æ›´ + ãƒ‡ãƒ—ãƒ­ã‚¤ | è¤‡æ•°æ‰‹é †ã®æ‰‹å‹•ä½œæ¥­ |
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | Parameter Store æ›´æ–° | é–¢æ•°å†ãƒ‡ãƒ—ãƒ­ã‚¤ | CloudFront å†è¨­å®š |
| ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° | CloudWatch Logs | CloudWatch Logs | CloudFront ãƒ¡ãƒˆãƒªã‚¯ã‚¹ |
| ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | ãƒ­ã‚°åˆ†æ | ãƒ­ã‚°åˆ†æ | è¨­å®šç¢ºèª |

### ğŸ¯ å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚¬ã‚¤ãƒ‰

#### Lambda@Edge ã‚’é¸æŠã™ã¹ãã‚±ãƒ¼ã‚¹

1. **æ™‚é–“å¸¯ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•åˆ¶å¾¡ãŒå¿…é ˆ**
   - æ¯æ—¥æ±ºã¾ã£ãŸæ™‚é–“ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸è¡¨ç¤º
   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå‹•çš„ã«å¤‰åŒ–
   - ä¾‹: æ¯æ—¥æ·±å¤œ0æ™‚ã€œ6æ™‚ã€é€±æœ«ã®ã¿ã€ç‰¹å®šæ—¥æ™‚

2. **å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºãŒå¿…è¦**
   - Parameter Store ã‹ã‚‰ã®è¨­å®šå–å¾—
   - DynamoDB ã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†
   - Secrets Manager ã‹ã‚‰ã®èªè¨¼æƒ…å ±å–å¾—

3. **è¤‡é›‘ãªæ¡ä»¶åˆ¤å®šãŒå¿…è¦**
   - è¤‡æ•°æ¡ä»¶ã®çµ„ã¿åˆã‚ã›ï¼ˆæ™‚é–“ AND IP AND User-Agentï¼‰
   - ã‚«ã‚¹ã‚¿ãƒ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
   - å¤–éƒ¨APIå‘¼ã³å‡ºã—ï¼ˆ5ç§’ä»¥å†…ï¼‰

4. **é«˜åº¦ãªå‹•çš„åˆ¶å¾¡**
   - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®æ¤œè¨¼
   - Cookie ã®è¤‡é›‘ãªå‡¦ç†
   - ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ

#### CloudFront Functions ã‚’é¸æŠã™ã¹ãã‚±ãƒ¼ã‚¹

1. **ã‚·ãƒ³ãƒ—ãƒ«ãªæ¡ä»¶åˆ¤å®šã®ã¿**
   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ•ãƒ©ã‚°ã® ON/OFF ã®ã¿
   - IP ãƒã‚¤ãƒ‘ã‚¹æ©Ÿèƒ½ï¼ˆWAFé€£æºï¼‰
   - User-Agent ã«ã‚ˆã‚‹ç°¡å˜ãªæŒ¯ã‚Šåˆ†ã‘

2. **ã‚³ã‚¹ãƒˆå‰Šæ¸›ãŒå„ªå…ˆäº‹é …**
   - Lambda@Edge ã‚ˆã‚Šç´„6å€å®‰ã„
   - é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç’°å¢ƒã§ã®ã‚³ã‚¹ãƒˆæœ€é©åŒ–

3. **ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒé‡è¦**
   - <1ms ã®å®Ÿè¡Œæ™‚é–“
   - CloudFront ã®ã‚¨ãƒƒã‚¸ã§å³åº§ã«å‡¦ç†

4. **å¤–éƒ¨é€£æºä¸è¦**
   - ã‚³ãƒ¼ãƒ‰å†…ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å¯èƒ½
   - ç’°å¢ƒå¤‰æ•°ã‚„Parameter Store ä¸è¦

#### æ‰‹å‹• Origin åˆ‡ã‚Šæ›¿ãˆã‚’é¸æŠã™ã¹ãã‚±ãƒ¼ã‚¹

1. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é »åº¦ãŒæ¥µã‚ã¦ä½ã„**
   - å¹´1ã€œ2å›ç¨‹åº¦
   - è¨ˆç”»çš„ãªé•·æ™‚é–“ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

2. **ã‚³ã‚¹ãƒˆæœ€å„ªå…ˆ**
   - Lambda/Function ã‚³ã‚¹ãƒˆå®Œå…¨å‰Šæ¸›
   - å°è¦æ¨¡ã‚µã‚¤ãƒˆãƒ»ä½äºˆç®—ç’°å¢ƒ

3. **ã‚·ãƒ³ãƒ—ãƒ«ã•é‡è¦–**
   - è¿½åŠ ã‚³ãƒ¼ãƒ‰ä¸è¦
   - CloudFront æ¨™æº–æ©Ÿèƒ½ã®ã¿

4. **åæ˜ æ™‚é–“ã‚’è¨±å®¹ã§ãã‚‹**
   - 15ã€œ30åˆ†ã®åˆ‡ã‚Šæ›¿ãˆæ™‚é–“ãŒå•é¡Œãªã„
   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ä½™è£•ãŒã‚ã‚‹

### ğŸ“ ã¾ã¨ã‚

**Q1: æ™‚é–“æŒ‡å®šã‚’è¡Œã†ãŸã‚ã«ã¯ Lambda@Edge ãŒå¿…è¦ï¼Ÿ**

â†’ **ã¯ã„ã€å¿…é ˆã§ã™ã€‚**

CloudFront Functions ã§ã¯ä»¥ä¸‹ã®åˆ¶ç´„ã«ã‚ˆã‚Šæ™‚é–“åˆ¤å®šãŒå›°é›£ï¼š
- Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆ¶é™
- å¤–éƒ¨APIå‘¼ã³å‡ºã—ä¸å¯ï¼ˆParameter Store èª­ã‚ãªã„ï¼‰
- ç’°å¢ƒå¤‰æ•°ã‚µãƒãƒ¼ãƒˆãªã—

**Q2: æ™‚é–“æŒ‡å®šãŒãªã‘ã‚Œã° Lambda@Edge ã¯ä¸è¦ï¼Ÿ**

â†’ **çŠ¶æ³æ¬¡ç¬¬ã§ã™ã€‚**

| è¦ä»¶ | æ¨å¥¨å®Ÿè£… | ç†ç”± |
|------|---------|------|
| IP ãƒã‚¤ãƒ‘ã‚¹ + å³åº§åˆ‡ã‚Šæ›¿ãˆ | CloudFront Functions | ã‚³ã‚¹ãƒˆ6å€å‰Šæ¸›ã€ååˆ†ãªæ©Ÿèƒ½ |
| Parameter Store é€£æº | Lambda@Edge | Functions ã§ã¯å¤–éƒ¨APIä¸å¯ |
| å¹´æ•°å›ã®æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆ | æ‰‹å‹• Origin å¤‰æ›´ | è¿½åŠ ã‚³ã‚¹ãƒˆä¸è¦ |

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

#### ç¾åœ¨ã®å®Ÿè£…ã‚’ç¶™ç¶šã™ã‚‹å ´åˆï¼ˆæ™‚é–“æŒ‡å®š**å¿…è¦**ï¼‰
```bash
# ç¾çŠ¶ç¶­æŒï¼ˆLambda@Edge å®Ÿè£…ï¼‰
# ã‚³ã‚¹ãƒˆ: $20.70/æœˆï¼ˆ100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
# ãƒ¡ãƒªãƒƒãƒˆ: å®Œå…¨è‡ªå‹•åˆ¶å¾¡ã€æŸ”è»Ÿæ€§æœ€å¤§
```

#### CloudFront Functions ã«ç§»è¡Œã™ã‚‹å ´åˆï¼ˆæ™‚é–“æŒ‡å®š**ä¸è¦**ï¼‰
```bash
# Lambda@Edge â†’ CloudFront Functions ç§»è¡Œ
# ã‚³ã‚¹ãƒˆå‰Šæ¸›: $4.33/æœˆï¼ˆ21%å‰Šæ¸›ï¼‰
# ãƒ¡ãƒªãƒƒãƒˆ: ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã€ãƒ‡ãƒ—ãƒ­ã‚¤é«˜é€Ÿ
# ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: Parameter Store é€£æºä¸å¯
```

#### æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆã«å¤‰æ›´ã™ã‚‹å ´åˆï¼ˆã‚³ã‚¹ãƒˆæœ€å„ªå…ˆï¼‰
```bash
# Lambda/Functions å‰Šé™¤ â†’ æ‰‹å‹• Origin åˆ‡ã‚Šæ›¿ãˆ
# ã‚³ã‚¹ãƒˆå‰Šæ¸›: $6.20/æœˆï¼ˆ30%å‰Šæ¸›ï¼‰
# ãƒ¡ãƒªãƒƒãƒˆ: æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«
# ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: åæ˜ ã«15ã€œ30åˆ†ã€æ‰‹å‹•ä½œæ¥­å¿…è¦
```

---

**è¿½è¨˜æ—¥**: 2025-12-17
**åˆ†æãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
