# ハンズオン 01: CodePipeline 基礎

## 概要

このハンズオンでは、AWS マネジメントコンソールを使用して、シンプルな CI/CD パイプラインを構築します。

**所要時間**: 約30分
**コスト**: 約$0.50以下（すべて削除すれば無料枠内）

## 学習目標

- CodePipeline の基本構造（Source → Build → Deploy）を理解する
- CodeCommit リポジトリの作成と接続
- CodeBuild プロジェクトの設定
- S3 へのデプロイ設定

---

## 前提条件

- AWS アカウント
- 管理者権限を持つ IAM ユーザー

---

## Step 1: CodeCommit リポジトリの作成

### 1.1 CodeCommit コンソールを開く

1. AWS マネジメントコンソールにログイン
2. 検索バーに「CodeCommit」と入力
3. **CodeCommit** をクリック

### 1.2 リポジトリを作成

1. **リポジトリを作成** ボタンをクリック
2. 以下を入力:

| 項目 | 値 |
|------|-----|
| リポジトリ名 | `dop-handson-repo` |
| 説明 | `DOP学習用リポジトリ` |

3. **作成** をクリック

### 1.3 サンプルファイルを追加

1. 作成したリポジトリをクリック
2. **ファイルの追加** → **ファイルの作成** をクリック
3. 以下のファイルを作成:

**ファイル名**: `index.html`

```html
<!DOCTYPE html>
<html>
<head>
    <title>DOP Handson</title>
</head>
<body>
    <h1>Hello from CodePipeline!</h1>
    <p>Version: 1.0.0</p>
</body>
</html>
```

4. 作成者名とメールアドレスを入力
5. **変更のコミット** をクリック

### 1.4 buildspec.yml を追加

1. **ファイルの追加** → **ファイルの作成** をクリック
2. 以下のファイルを作成:

**ファイル名**: `buildspec.yml`

```yaml
version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
  build:
    commands:
      - echo "Building..."
      - echo "Build completed on $(date)"

artifacts:
  files:
    - '**/*'
```

3. **変更のコミット** をクリック

---

## Step 2: S3 バケットの作成（デプロイ先）

### 2.1 S3 コンソールを開く

1. 検索バーに「S3」と入力
2. **S3** をクリック

### 2.2 バケットを作成

1. **バケットを作成** をクリック
2. 以下を入力:

| 項目 | 値 |
|------|-----|
| バケット名 | `dop-handson-deploy-{あなたのアカウントID}` |
| リージョン | `ap-northeast-1` (東京) |

3. **パブリックアクセスをすべてブロック** のチェックを**外す**
4. 「現在の設定により、このバケットとバケット内のオブジェクトがパブリックになる可能性があることを承認します」にチェック
5. **バケットを作成** をクリック

### 2.3 静的ウェブサイトホスティングを有効化

1. 作成したバケットをクリック
2. **プロパティ** タブをクリック
3. 一番下の **静的ウェブサイトホスティング** で **編集** をクリック
4. 以下を設定:

| 項目 | 値 |
|------|-----|
| 静的ウェブサイトホスティング | 有効にする |
| インデックスドキュメント | `index.html` |

5. **変更の保存** をクリック

### 2.4 バケットポリシーを設定

1. **アクセス許可** タブをクリック
2. **バケットポリシー** で **編集** をクリック
3. 以下のポリシーを貼り付け（バケット名を置き換え）:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::dop-handson-deploy-{あなたのアカウントID}/*"
        }
    ]
}
```

4. **変更の保存** をクリック

---

## Step 3: CodePipeline の作成

### 3.1 CodePipeline コンソールを開く

1. 検索バーに「CodePipeline」と入力
2. **CodePipeline** をクリック

### 3.2 パイプラインを作成

1. **パイプラインを作成する** をクリック

### 3.3 パイプライン設定

**ステップ 1: パイプラインの設定**

| 項目 | 値 |
|------|-----|
| パイプライン名 | `dop-handson-pipeline` |
| パイプラインタイプ | V2 |
| サービスロール | 新しいサービスロール |
| ロール名 | `AWSCodePipelineServiceRole-dop-handson` |

**詳細設定** を展開:

| 項目 | 値 |
|------|-----|
| アーティファクトストア | デフォルトの場所 |

**次に** をクリック

### 3.4 ソースステージ

**ステップ 2: ソースステージを追加する**

| 項目 | 値 |
|------|-----|
| ソースプロバイダー | AWS CodeCommit |
| リポジトリ名 | `dop-handson-repo` |
| ブランチ名 | `main` (または `master`) |
| 検出オプション | Amazon CloudWatch Events |

**次に** をクリック

### 3.5 ビルドステージ

**ステップ 3: ビルドステージを追加する**

| 項目 | 値 |
|------|-----|
| ビルドプロバイダー | AWS CodeBuild |
| リージョン | アジアパシフィック (東京) |
| プロジェクト名 | **プロジェクトを作成する** をクリック |

#### CodeBuild プロジェクト作成（ポップアップ）

| セクション | 項目 | 値 |
|-----------|------|-----|
| プロジェクトの設定 | プロジェクト名 | `dop-handson-build` |
| 環境 | 環境イメージ | マネージド型イメージ |
| 環境 | オペレーティングシステム | Amazon Linux |
| 環境 | ランタイム | Standard |
| 環境 | イメージ | aws/codebuild/amazonlinux-x86_64-standard:5.0 |
| 環境 | サービスロール | 新しいサービスロール |
| Buildspec | ビルド仕様 | buildspec ファイルを使用する |

**CodePipeline に進む** をクリック

**次に** をクリック

### 3.6 デプロイステージ

**ステップ 4: デプロイステージを追加する**

| 項目 | 値 |
|------|-----|
| デプロイプロバイダー | Amazon S3 |
| リージョン | アジアパシフィック (東京) |
| バケット | `dop-handson-deploy-{あなたのアカウントID}` |
| デプロイする前にファイルを抽出する | ✅ チェック |

**次に** をクリック

### 3.7 確認と作成

1. 設定内容を確認
2. **パイプラインを作成する** をクリック

---

## Step 4: パイプラインの実行確認

### 4.1 自動実行の確認

パイプライン作成後、自動的に実行が開始されます。

1. **Source** ステージが緑色（成功）になるまで待つ
2. **Build** ステージが緑色（成功）になるまで待つ
3. **Deploy** ステージが緑色（成功）になるまで待つ

### 4.2 デプロイ結果の確認

1. S3 コンソールを開く
2. `dop-handson-deploy-{あなたのアカウントID}` バケットをクリック
3. **プロパティ** タブ → **静的ウェブサイトホスティング** のURLをクリック
4. 「Hello from CodePipeline!」が表示されれば成功

---

## Step 5: 変更をプッシュして自動デプロイ確認

### 5.1 CodeCommit でファイルを編集

1. CodeCommit コンソールで `dop-handson-repo` を開く
2. `index.html` をクリック
3. **編集** をクリック
4. バージョンを変更:

```html
<p>Version: 2.0.0</p>
```

5. **変更のコミット** をクリック

### 5.2 パイプライン自動実行の確認

1. CodePipeline コンソールを開く
2. `dop-handson-pipeline` をクリック
3. 自動的にパイプラインが実行されることを確認
4. 完了後、S3 のウェブサイトで「Version: 2.0.0」が表示されることを確認

---

## Step 6: リソースのクリーンアップ

### 6.1 パイプラインの削除

1. CodePipeline コンソールで `dop-handson-pipeline` を選択
2. **削除** をクリック
3. 確認画面で「delete」と入力して削除

### 6.2 CodeBuild プロジェクトの削除

1. CodeBuild コンソールを開く
2. `dop-handson-build` を選択
3. **削除** をクリック

### 6.3 S3 バケットの削除

1. S3 コンソールを開く
2. `dop-handson-deploy-{アカウントID}` を選択
3. **空にする** をクリック（中身を削除）
4. **削除** をクリック

### 6.4 CodeCommit リポジトリの削除

1. CodeCommit コンソールを開く
2. `dop-handson-repo` を選択
3. **削除** をクリック

### 6.5 アーティファクト用 S3 バケットの削除

1. S3 コンソールで `codepipeline-ap-northeast-1-*` を検索
2. 該当バケットを空にして削除

### 6.6 IAM ロールの削除（オプション）

1. IAM コンソールを開く
2. 以下のロールを削除:
   - `AWSCodePipelineServiceRole-dop-handson`
   - `codebuild-dop-handson-build-service-role`

---

## 学習のポイント

### パイプラインの構造

```
┌─────────────────────────────────────────────────────────────┐
│                     CodePipeline                            │
│                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐               │
│   │ Source  │───→│  Build  │───→│ Deploy  │               │
│   │         │    │         │    │         │               │
│   │CodeCommit│   │CodeBuild│    │   S3    │               │
│   └─────────┘    └─────────┘    └─────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 重要な概念

| 概念 | 説明 |
|------|------|
| **ステージ** | パイプラインの論理的な区切り（Source, Build, Deploy） |
| **アクション** | ステージ内で実行される個別のタスク |
| **アーティファクト** | ステージ間で受け渡されるファイル群 |
| **サービスロール** | パイプラインが他の AWS サービスにアクセスするための権限 |

### DOP試験での出題ポイント

- パイプラインタイプ V1 vs V2 の違い
- ソースプロバイダーの選択（CodeCommit, GitHub, S3）
- 手動承認アクションの設定
- クロスリージョン・クロスアカウントデプロイ

---

## 次のステップ

- [ハンズオン 02: CodeDeploy による EC2 デプロイ](./handson-02-codedeploy-ec2.md)
- [ハンズオン 03: CodePipeline 手動承認](./handson-03-manual-approval.md)
