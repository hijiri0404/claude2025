# AWS KMS (Key Management Service) ハンズオンガイド

> **対象**: AWS DevOps Professional (DOP-C02) 試験対策
> **前提知識**: AWS基礎、IAM、S3、RDS、Lambda
> **所要時間**: 約3時間

---

## 目次

1. [KMS概要](#1-kms概要)
2. [キーの種類と管理](#2-キーの種類と管理)
3. [キーポリシーとアクセス制御](#3-キーポリシーとアクセス制御)
4. [エンベロープ暗号化](#4-エンベロープ暗号化)
5. [キーローテーション](#5-キーローテーション)
6. [クロスアカウント・クロスリージョン](#6-クロスアカウントクロスリージョン)
7. [AWSサービスとの統合](#7-awsサービスとの統合)
8. [ハンズオン演習](#8-ハンズオン演習)
9. [DOP試験対策チェックリスト](#9-dop試験対策チェックリスト)

---

## 1. KMS概要

### 1.1 KMSとは

```
┌─────────────────────────────────────────────────────────────────────┐
│                      AWS Key Management Service                     │
│                暗号化キーの作成・管理・制御サービス                  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   キーの種類                                   │  │
│  │                                                               │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │  │
│  │  │ AWS管理キー  │  │ カスタマー   │  │ カスタマー   │       │  │
│  │  │ (aws/s3等)   │  │ 管理キー     │  │ 管理キー     │       │  │
│  │  │              │  │ (CMK)        │  │ (インポート) │       │  │
│  │  │ 自動作成     │  │ KMSで生成    │  │ 外部キー     │       │  │
│  │  │ 自動ローテ   │  │ ユーザー管理 │  │ BYOK         │       │  │
│  │  │ 削除不可     │  │ ポリシー設定 │  │ 手動ローテ   │       │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘       │  │
│  │                                                               │  │
│  │  ┌──────────────┐  ┌──────────────┐                          │  │
│  │  │ AWS所有キー  │  │ カスタム     │                          │  │
│  │  │              │  │ キーストア   │                          │  │
│  │  │ AWS内部で    │  │              │                          │  │
│  │  │ 使用         │  │ CloudHSM     │                          │  │
│  │  │ 見えない     │  │ 外部キーストア│                         │  │
│  │  └──────────────┘  └──────────────┘                          │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  暗号化方式: エンベロープ暗号化（データキー + マスターキー）        │
│  FIPS 140-2 Level 2 (標準) / Level 3 (CloudHSM)                    │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 DOP試験での重要ポイント

| トピック | 重要度 | 出題パターン |
|---------|--------|-------------|
| **エンベロープ暗号化** | ★★★★★ | データキーとマスターキーの関係 |
| **キーポリシー** | ★★★★★ | アクセス制御の設計 |
| **クロスアカウント暗号化** | ★★★★★ | マルチアカウントでの共有 |
| **キーローテーション** | ★★★★★ | 自動 vs 手動、影響範囲 |
| **サービス統合** | ★★★★★ | S3/EBS/RDS/Lambda/SQS等 |
| **グラント** | ★★★★☆ | 一時的なアクセス許可 |
| **キー削除** | ★★★★☆ | 待機期間、無効化との違い |
| **BYOK** | ★★★☆☆ | インポートキーの制約 |

---

## 2. キーの種類と管理

### 2.1 キーの分類

```
【KMSキーの分類マトリクス】

┌─────────────────┬──────────┬──────────┬──────────┬──────────────────┐
│                 │ AWS所有  │ AWS管理  │ カスタマー│ インポートキー   │
│                 │ キー     │ キー     │ 管理CMK  │ (BYOK)          │
├─────────────────┼──────────┼──────────┼──────────┼──────────────────┤
│ 作成者          │ AWS      │ AWS      │ ユーザー │ ユーザー(外部)   │
│ キーポリシー    │ ×       │ 閲覧のみ │ 完全制御 │ 完全制御         │
│ 自動ローテーション│ 不定    │ 1年毎   │ 設定可能 │ 手動のみ         │
│ 削除            │ ×       │ ×       │ 可(待機) │ 可(待機)         │
│ CloudTrail記録  │ ×       │ ○       │ ○       │ ○               │
│ 料金            │ 無料     │ 無料     │ $1/月    │ $1/月            │
│ API利用料金     │ 無料     │ あり     │ あり     │ あり             │
│ リージョン      │ -        │ リージョン│ リージョン│ リージョン       │
│ マルチリージョン│ -        │ ×       │ ○       │ ×               │
└─────────────────┴──────────┴──────────┴──────────┴──────────────────┘
```

### 2.2 対称キー vs 非対称キー

```
【対称キー（Symmetric）】
- アルゴリズム: AES-256-GCM
- 用途: 暗号化/復号、エンベロープ暗号化
- 特徴: キーマテリアルはKMS外に出ない
- AWSサービス統合: 全サービスで使用可能

【非対称キー（Asymmetric）】
- アルゴリズム: RSA, ECC
- 用途: 署名/検証、KMS外での暗号化
- 特徴: 公開鍵をダウンロード可能
- 用途例: クライアント側暗号化、デジタル署名
```

### 2.3 キーのライフサイクル

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  作成    │───▶│  有効    │───▶│  無効    │───▶│ 削除予定 │
│ (Create) │    │(Enabled) │    │(Disabled)│    │(Pending  │
│          │    │          │    │          │    │ Deletion)│
└──────────┘    └──────────┘    └──────────┘    └────┬─────┘
                     ▲               │                │
                     │               │          7〜30日待機
                     └───────────────┘                │
                      再有効化可能                     ▼
                                              ┌──────────┐
                                              │  削除済  │
                                              │(Deleted) │
                                              │ 復元不可 │
                                              └──────────┘
```

**DOP重要ポイント**:
- 削除待機期間はデフォルト30日（7〜30日で指定可能）
- 待機中はキーの状態が`PendingDeletion`
- 待機中にキャンセル可能（`cancel-key-deletion`）
- 削除されたキーで暗号化されたデータは**永久に復号不可**

---

## 3. キーポリシーとアクセス制御

### 3.1 アクセス制御の3層構造

```
【KMSアクセス制御の評価フロー】

リクエスト
    │
    ▼
┌─────────────────────┐
│  キーポリシー        │ ← 必須（すべてのKMSキーに存在）
│  (Key Policy)       │
│                     │
│  キーに直接設定     │
│  最も優先度が高い   │
└─────────┬───────────┘
          │ 許可？
          ▼
┌─────────────────────┐
│  IAMポリシー         │ ← キーポリシーがIAMを許可した場合のみ評価
│  (IAM Policy)       │
│                     │
│  ユーザー/ロールに  │
│  アタッチ           │
└─────────┬───────────┘
          │ 許可？
          ▼
┌─────────────────────┐
│  グラント            │ ← 一時的・プログラム的なアクセス
│  (Grant)            │
│                     │
│  AWSサービスが      │
│  内部的に使用       │
└─────────────────────┘
```

### 3.2 デフォルトキーポリシー

```json
{
  "Version": "2012-10-17",
  "Id": "key-default-1",
  "Statement": [
    {
      "Sid": "Enable IAM policies",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:root"
      },
      "Action": "kms:*",
      "Resource": "*"
    }
  ]
}
```

**DOP重要ポイント**:
- このステートメントは「IAMポリシーによるアクセスを許可する」意味
- これがないと、IAMポリシーでkms権限を付与しても使えない
- `root`プリンシパル = アカウント内のIAMポリシーに制御を委任

### 3.3 クロスアカウント用キーポリシー

```json
{
  "Sid": "Allow external account",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::999888777666:root"
  },
  "Action": [
    "kms:Decrypt",
    "kms:DescribeKey",
    "kms:GenerateDataKey*"
  ],
  "Resource": "*"
}
```

**2段階の許可が必要**:
1. キーポリシーで外部アカウントを許可
2. 外部アカウント側のIAMポリシーでkmsアクションを許可

### 3.4 グラント（Grant）

```
【グラントの仕組み】

┌──────────────┐                    ┌──────────────┐
│ グラント発行者 │ ─── CreateGrant ──▶│  KMS キー    │
│ (Grantor)    │                    │              │
└──────────────┘                    └──────┬───────┘
                                          │
                                  グラントトークン
                                          │
                                          ▼
                                   ┌──────────────┐
                                   │ 被付与者      │
                                   │ (Grantee)    │
                                   │              │
                                   │ 指定された   │
                                   │ 操作のみ可能 │
                                   └──────────────┘

グラントの特徴:
- プログラムによる一時的なアクセス許可
- AWSサービスが内部的に使用（EBS, RDS等）
- 結果整合性（即時反映にはグラントトークンを使用）
- RetireGrant / RevokeGrant で取り消し
```

**DOP出題パターン**:
- EBSボリュームの暗号化でEC2がKMSキーを使用する仕組み → グラント
- 「一時的にキーへのアクセスを許可したい」→ グラント

---

## 4. エンベロープ暗号化

### 4.1 エンベロープ暗号化の仕組み

```
【エンベロープ暗号化フロー】

■ 暗号化時:

1. GenerateDataKey API
   ┌─────────┐                    ┌─────────┐
   │ アプリ   │ ──GenerateDataKey──▶│  KMS    │
   │          │                    │         │
   │          │ ◀─────────────────│         │
   │          │  平文データキー     │         │
   │          │  暗号化データキー   │         │
   └─────────┘                    └─────────┘

2. ローカルで暗号化
   ┌─────────┐
   │ アプリ   │
   │          │  平文データキー で データを暗号化
   │          │  ↓
   │          │  平文データキーを メモリから削除
   │          │  ↓
   │          │  暗号化データキー + 暗号化データ を保存
   └─────────┘

■ 復号時:

1. Decrypt API
   ┌─────────┐                    ┌─────────┐
   │ アプリ   │ ──Decrypt──────────▶│  KMS    │
   │          │  (暗号化データキー) │         │
   │          │ ◀─────────────────│         │
   │          │  平文データキー     │         │
   └─────────┘                    └─────────┘

2. ローカルで復号
   ┌─────────┐
   │ アプリ   │
   │          │  平文データキー で データを復号
   │          │  ↓
   │          │  平文データキーを メモリから削除
   └─────────┘
```

### 4.2 なぜエンベロープ暗号化か

| 方式 | 問題点 |
|------|--------|
| KMSで直接暗号化 | 4KB制限、ネットワーク遅延、APIコール数制限 |
| エンベロープ暗号化 | 大容量データ対応、ローカル高速処理、KMS負荷軽減 |

### 4.3 GenerateDataKey vs GenerateDataKeyWithoutPlaintext

```
GenerateDataKey:
  → 平文 + 暗号化 の両方のデータキーを返す
  → すぐに暗号化する場合に使用

GenerateDataKeyWithoutPlaintext:
  → 暗号化データキーのみ返す
  → 後で使用する場合（S3に保存しておく等）
  → 平文キーがメモリに載らないのでより安全
```

---

## 5. キーローテーション

### 5.1 ローテーション方式の比較

```
┌─────────────────────────────────────────────────────────────────────┐
│                    キーローテーション                                │
│                                                                     │
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐  │
│  │   自動ローテーション     │  │   手動ローテーション             │  │
│  │                         │  │                                 │  │
│  │ ・カスタマー管理CMKのみ  │  │ ・全キータイプ対象              │  │
│  │ ・対称キーのみ          │  │ ・新キー作成 + エイリアス変更   │  │
│  │ ・90〜2560日で指定      │  │ ・旧キーは復号用に保持          │  │
│  │ ・キーIDは変わらない     │  │ ・キーIDが変わる               │  │
│  │ ・バッキングキーが変更   │  │ ・アプリ側の参照先変更が必要   │  │
│  │ ・旧データ復号は自動対応 │  │ ・エイリアス使用で透過的に対応  │  │
│  │ ・透過的（アプリ変更不要）│  │                                │  │
│  └─────────────────────────┘  └─────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ AWS管理キー: 自動ローテーション（1年毎、変更不可）              ││
│  │ インポートキー: 自動ローテーション不可、手動のみ                ││
│  │ 非対称キー: 自動ローテーション不可                              ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 自動ローテーションの内部動作

```
【自動ローテーション時の内部動作】

キーID: 1234abcd-xxxx (変わらない)

ローテーション前:
  バッキングキー v1 ── 暗号化 & 復号に使用

ローテーション後:
  バッキングキー v2 ── 新規暗号化に使用
  バッキングキー v1 ── 旧データの復号に自動使用

  ※ KMSが暗号文のメタデータから適切なバッキングキーを自動選択
  ※ アプリケーション側の変更は不要
```

**DOP重要ポイント**: 「キーローテーション後、過去に暗号化されたデータはどうなるか？」→ 旧バッキングキーが保持されるため、透過的に復号可能

---

## 6. クロスアカウント・クロスリージョン

### 6.1 クロスアカウント暗号化パターン

```
【クロスアカウントS3暗号化】

Account A (キー所有者)              Account B (データ利用者)
┌────────────────────┐             ┌────────────────────┐
│                    │             │                    │
│  KMS Key           │             │  IAM Role          │
│  ┌──────────────┐  │             │  ┌──────────────┐  │
│  │ キーポリシー  │  │◀── 復号 ──│  │ kms:Decrypt  │  │
│  │              │  │  リクエスト │  │ kms:Generate │  │
│  │ Account Bを  │  │             │  │ DataKey*     │  │
│  │ 許可         │  │             │  └──────────────┘  │
│  └──────────────┘  │             │                    │
│                    │             │  S3バケット         │
│                    │             │  ┌──────────────┐  │
│                    │             │  │ SSE-KMS      │  │
│                    │             │  │ Account Aの  │  │
│                    │             │  │ キーを指定   │  │
│                    │             │  └──────────────┘  │
└────────────────────┘             └────────────────────┘

必要な設定:
1. Account A: キーポリシーでAccount Bを許可
2. Account B: IAMポリシーでkmsアクションを許可
3. Account B: S3バケットポリシー or IAMでS3アクセス許可
```

### 6.2 マルチリージョンキー

```
【マルチリージョンキー】

  Primary Key                  Replica Key
  (ap-northeast-1)            (us-east-1)
  ┌──────────────┐            ┌──────────────┐
  │ mrk-1234abcd │ ──複製──▶ │ mrk-1234abcd │
  │              │            │              │
  │ 同じキーID   │            │ 同じキーID   │
  │ 同じキー     │            │ 同じキー     │
  │ マテリアル   │            │ マテリアル   │
  └──────────────┘            └──────────────┘

  特徴:
  - 同じキーIDとキーマテリアル
  - リージョン間で暗号化/復号が透過的
  - DRシナリオ、グローバルアプリケーション向け
  - S3レプリケーション + SSE-KMS で有用
  - 各リージョンで独立したキーポリシー設定可能

  制約:
  - プライマリは1つのみ
  - レプリカは独立して削除不可（プライマリ削除が先）
  - 追加コスト: レプリカキーごとに$1/月
```

### 6.3 クロスリージョンS3レプリケーション + KMS

```
【S3 CRR + SSE-KMS の構成】

ソースバケット (ap-northeast-1)      レプリカバケット (us-east-1)
┌──────────────────────┐            ┌──────────────────────┐
│ SSE-KMS              │            │ SSE-KMS              │
│ Key: key-A           │──レプリ──▶│ Key: key-B           │
└──────────────────────┘  ケーション └──────────────────────┘

レプリケーションルールで指定:
- ソースキー(key-A)でDecrypt権限
- レプリカキー(key-B)でEncrypt権限
- IAMロールに両方のキーへのアクセスが必要

※ マルチリージョンキーを使えば同一キーで統一可能
```

---

## 7. AWSサービスとの統合

### 7.1 主要サービスとの統合パターン

```
┌─────────────────────────────────────────────────────────────────────┐
│                   KMS統合サービスマップ                              │
│                                                                     │
│  ストレージ暗号化 (Server-Side Encryption)                          │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                    │
│  │  S3  │ │ EBS  │ │ EFS  │ │ RDS  │ │Dynamo│                    │
│  │SSE-KMS│ │暗号化│ │暗号化│ │TDE   │ │ DB   │                    │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘                    │
│                                                                     │
│  メッセージング暗号化                                               │
│  ┌──────┐ ┌──────┐ ┌──────┐                                       │
│  │ SQS  │ │ SNS  │ │Kinesis│                                      │
│  │SSE   │ │SSE   │ │SSE   │                                       │
│  └──────┘ └──────┘ └──────┘                                       │
│                                                                     │
│  コンピュート                                                       │
│  ┌──────┐ ┌──────┐ ┌──────┐                                       │
│  │Lambda│ │Secrets│ │Systems│                                      │
│  │環境変数│ │Manager│ │Manager│                                     │
│  │暗号化│ │暗号化│ │SecStr│                                       │
│  └──────┘ └──────┘ └──────┘                                       │
│                                                                     │
│  ログ・監視                                                         │
│  ┌──────┐ ┌──────┐ ┌──────┐                                       │
│  │Cloud │ │Cloud │ │ ACM  │                                       │
│  │Watch │ │Trail │ │証明書│                                       │
│  │Logs  │ │ログ  │ │      │                                       │
│  └──────┘ └──────┘ └──────┘                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 S3暗号化オプション

| 方式 | キー管理 | KMSコール | コスト |
|------|---------|----------|-------|
| SSE-S3 (AES-256) | AWS完全管理 | なし | 無料 |
| SSE-KMS | AWS管理 or CMK | あり | API料金 |
| SSE-KMS + バケットキー | CMK | 大幅削減 | API料金削減 |
| SSE-C | 顧客提供キー | なし | 無料 |
| CSE | クライアント側 | 任意 | 任意 |

**DOP重要ポイント**:
- SSE-KMSのAPI呼び出し制限（リージョンごとに5,500〜30,000 req/sec）
- **S3バケットキー**で99%のKMS APIコールを削減
- SSE-CはAWSにキーを保存しない（リクエスト毎にキーを送信）

### 7.3 EBS暗号化

```
【EBS暗号化の動作】

EC2インスタンス
┌────────────────────────────┐
│                            │
│  ┌──────────────────────┐  │      ┌──────────┐
│  │ EBS暗号化ボリューム  │  │      │   KMS    │
│  │                      │  │      │          │
│  │ データキーで暗号化   │──┼─────▶│ グラント │
│  │ (メモリ上にキャッシュ)│  │      │ 経由で   │
│  │                      │  │      │ データキー│
│  └──────────────────────┘  │      │ を復号   │
│                            │      └──────────┘
└────────────────────────────┘

重要:
- デフォルト暗号化を有効化可能（アカウントレベル）
- スナップショットもキーで暗号化
- 暗号化スナップショットから別キーで再暗号化可能
- 暗号化されていないボリューム → スナップショット → 暗号化コピー → 新ボリューム
```

### 7.4 Lambda環境変数の暗号化

```
【Lambda環境変数暗号化】

デプロイ時:
  環境変数 ── KMSキーで暗号化 ── 保存

実行時:
  Lambda関数起動 → 環境変数を自動復号 → 関数コードに提供

  ※ Lambdaサービスがグラントを使ってKMSキーにアクセス
  ※ カスタムCMKを指定可能（デフォルトはaws/lambda）
  ※ 関数コード内で追加の復号処理も可能（ヘルパー暗号化）
```

---

## 8. ハンズオン演習

### 演習1: CMK作成とキーポリシー設定

```bash
# 1. カスタマー管理キー（対称）の作成
aws kms create-key \
  --description "DOP-handson-key" \
  --key-usage ENCRYPT_DECRYPT \
  --origin AWS_KMS \
  --query 'KeyMetadata.KeyId' \
  --output text

# 結果からキーIDを変数に設定
KEY_ID="<出力されたキーID>"

# 2. エイリアスの作成
aws kms create-alias \
  --alias-name alias/dop-handson \
  --target-key-id ${KEY_ID}

# 3. キー情報の確認
aws kms describe-key \
  --key-id alias/dop-handson \
  --query 'KeyMetadata.{KeyId:KeyId,State:KeyState,Manager:KeyManager,Rotation:RotationStatus,Origin:Origin}'

# 4. キーポリシーの取得
aws kms get-key-policy \
  --key-id ${KEY_ID} \
  --policy-name default \
  --output text

# 5. エイリアス一覧の確認
aws kms list-aliases \
  --query 'Aliases[?starts_with(AliasName, `alias/dop`)]'
```

### 演習2: エンベロープ暗号化の実践

```bash
# 1. データキーの生成
aws kms generate-data-key \
  --key-id alias/dop-handson \
  --key-spec AES_256 \
  --query '{Plaintext:Plaintext,CiphertextBlob:CiphertextBlob}'

# 2. 平文データキーなしでデータキー生成
aws kms generate-data-key-without-plaintext \
  --key-id alias/dop-handson \
  --key-spec AES_256 \
  --query 'CiphertextBlob' \
  --output text

# 3. テキストの直接暗号化（4KB以下）
echo "DOP-C02 secret data" > /tmp/plaintext.txt

aws kms encrypt \
  --key-id alias/dop-handson \
  --plaintext fileb:///tmp/plaintext.txt \
  --query 'CiphertextBlob' \
  --output text > /tmp/ciphertext.b64

# 4. 復号
aws kms decrypt \
  --ciphertext-blob fileb://<(base64 -d /tmp/ciphertext.b64) \
  --query 'Plaintext' \
  --output text | base64 -d

# 5. 暗号化コンテキストの使用
aws kms encrypt \
  --key-id alias/dop-handson \
  --plaintext fileb:///tmp/plaintext.txt \
  --encryption-context "Purpose=DOP,Environment=Test" \
  --query 'CiphertextBlob' \
  --output text > /tmp/ciphertext_ctx.b64
```

### 演習3: キーローテーション

```bash
# 1. 自動ローテーションの有効化
aws kms enable-key-rotation \
  --key-id ${KEY_ID}

# 2. ローテーション状態の確認
aws kms get-key-rotation-status \
  --key-id ${KEY_ID}

# 3. ローテーション期間の設定（180日）
aws kms update-key-rotation-period \
  --key-id ${KEY_ID} \
  --rotation-period-in-days 180

# 4. 手動ローテーション（新キー作成 + エイリアス切替）
NEW_KEY_ID=$(aws kms create-key \
  --description "DOP-handson-key-v2" \
  --query 'KeyMetadata.KeyId' \
  --output text)

aws kms update-alias \
  --alias-name alias/dop-handson \
  --target-key-id ${NEW_KEY_ID}

# エイリアス経由のアクセスは自動的に新キーを使用
# 旧キーは残っているので、過去の暗号化データの復号は可能
```

### 演習4: グラントの操作

```bash
# 1. グラントの作成
GRANT_ID=$(aws kms create-grant \
  --key-id ${KEY_ID} \
  --grantee-principal "arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/LambdaExecutionRole" \
  --operations Decrypt GenerateDataKey \
  --query 'GrantId' \
  --output text)

# 2. グラント一覧の確認
aws kms list-grants \
  --key-id ${KEY_ID} \
  --query 'Grants[].{Id:GrantId,Principal:GranteePrincipal,Operations:Operations}'

# 3. グラントの取り消し
aws kms revoke-grant \
  --key-id ${KEY_ID} \
  --grant-id ${GRANT_ID}
```

### 演習5: S3 SSE-KMS暗号化

```bash
# 1. バケット作成
BUCKET_NAME="dop-kms-test-$(date +%s)"
aws s3 mb s3://${BUCKET_NAME}

# 2. デフォルト暗号化の設定（SSE-KMS）
aws s3api put-bucket-encryption \
  --bucket ${BUCKET_NAME} \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "aws:kms",
        "KMSMasterKeyID": "'${KEY_ID}'"
      },
      "BucketKeyEnabled": true
    }]
  }'

# 3. 暗号化設定の確認
aws s3api get-bucket-encryption \
  --bucket ${BUCKET_NAME}

# 4. ファイルアップロード（自動暗号化）
echo "test data" | aws s3 cp - s3://${BUCKET_NAME}/test.txt

# 5. オブジェクトの暗号化情報確認
aws s3api head-object \
  --bucket ${BUCKET_NAME} \
  --key test.txt \
  --query '{Encryption:ServerSideEncryption,KeyId:SSEKMSKeyId,BucketKey:BucketKeyEnabled}'

# 6. クリーンアップ
aws s3 rb s3://${BUCKET_NAME} --force
```

### 演習6: キーの無効化と削除

```bash
# 1. キーの無効化
aws kms disable-key --key-id ${KEY_ID}

# 2. 状態確認
aws kms describe-key \
  --key-id ${KEY_ID} \
  --query 'KeyMetadata.KeyState'
# → "Disabled"

# 3. 無効化中は暗号化不可
aws kms encrypt \
  --key-id ${KEY_ID} \
  --plaintext "test" 2>&1
# → DisabledException

# 4. 再有効化
aws kms enable-key --key-id ${KEY_ID}

# 5. 削除のスケジュール（最短7日）
aws kms schedule-key-deletion \
  --key-id ${KEY_ID} \
  --pending-window-in-days 7

# 6. 削除のキャンセル
aws kms cancel-key-deletion \
  --key-id ${KEY_ID}

# キャンセル後は Disabled 状態なので再有効化が必要
aws kms enable-key --key-id ${KEY_ID}
```

---

## 9. DOP試験対策チェックリスト

### Q1: エンベロープ暗号化
**Q: KMSで大容量データを暗号化する際に使われる方式は？直接暗号化との違いは？**

<details><summary>模範解答</summary>

エンベロープ暗号化を使用する。`GenerateDataKey` APIでデータキー（平文+暗号化済み）を取得し、平文データキーでローカル暗号化を行い、暗号化済みデータキーとともに保存する。直接暗号化は4KB制限があり、ネットワーク遅延やAPI制限の問題がある。エンベロープ暗号化はこれらを解決し、大容量データに対応する。

</details>

### Q2: キーローテーション
**Q: カスタマー管理CMKの自動ローテーションを有効にした場合、過去に暗号化されたデータはどうなるか？**

<details><summary>模範解答</summary>

過去のデータは引き続き復号可能。自動ローテーションではキーIDは変わらず、内部のバッキングキーが新しくなる。KMSは暗号文のメタデータから適切なバッキングキーを自動選択して復号する。アプリケーション側の変更は不要。新規暗号化のみ新バッキングキーが使用される。

</details>

### Q3: クロスアカウント暗号化
**Q: Account AのKMSキーでAccount BのS3バケットのデータを暗号化するには何が必要か？**

<details><summary>模範解答</summary>

2段階の許可が必要。①Account Aのキーポリシーで、Account B（またはその特定ロール）にkms:Decrypt、kms:GenerateDataKey*を許可。②Account BのIAMポリシーで、Account AのキーARNに対するkmsアクションを許可。加えて、S3バケットポリシーまたはIAMポリシーでS3操作の許可も必要。

</details>

### Q4: キーポリシー vs IAMポリシー
**Q: KMSキーのデフォルトキーポリシーにある `"Principal": {"AWS": "arn:aws:iam::123456789012:root"}` の意味は？**

<details><summary>模範解答</summary>

これはrootユーザーにアクセスを与えるのではなく、「このアカウントのIAMポリシーによるアクセス制御を有効にする」という意味。このステートメントがないと、IAMポリシーでkms権限を付与してもキーにアクセスできない。キーポリシーがすべてのKMSアクセスの出発点となる。

</details>

### Q5: S3バケットキー
**Q: S3バケットキーの目的と効果は？**

<details><summary>模範解答</summary>

S3バケットキーはSSE-KMS使用時のKMS APIコールを最大99%削減する機能。バケットレベルのキーを生成し、一定期間キャッシュすることで、オブジェクトごとのKMS API呼び出しを不要にする。大量のオブジェクトを持つバケットでのKMSコスト削減とAPIスロットリング回避に有効。ただし、CloudTrailログはバケットレベルの記録となり、オブジェクト単位のKMSログは記録されなくなる。

</details>

### Q6: グラント
**Q: KMSグラントとは何か？どのような場面で使用されるか？**

<details><summary>模範解答</summary>

グラントはKMSキーへのプログラム的な一時アクセス許可メカニズム。AWSサービスが内部的に使用する（例: EBSがEC2インスタンスの起動時にボリューム復号用のグラントを作成）。キーポリシーやIAMポリシーの変更なしに、特定のプリンシパルに限定的なKMS操作を許可できる。結果整合性のため、即時利用にはグラントトークンの使用が必要。

</details>

### Q7: キー削除
**Q: KMSキーを削除する際の注意点とベストプラクティスは？**

<details><summary>模範解答</summary>

キー削除には7〜30日の待機期間（デフォルト30日）が必須。削除されたキーで暗号化されたデータは永久に復号不可。ベストプラクティス: ①まずキーを無効化して影響を確認 ②CloudTrailでキーの使用状況を確認 ③CloudWatchアラームでDisabledキーへのアクセス試行を監視 ④本当に不要と確認してから削除をスケジュール。待機期間中はcancel-key-deletionでキャンセル可能。

</details>

### Q8: マルチリージョンキー
**Q: マルチリージョンキーのユースケースとシングルリージョンキーとの違いは？**

<details><summary>模範解答</summary>

マルチリージョンキーは同じキーIDとキーマテリアルを複数リージョンで共有する。ユースケース: ①S3クロスリージョンレプリケーション+SSE-KMS ②DynamoDB Global Tables ③DR時のデータアクセス ④グローバルアプリケーション。シングルリージョンキーとの違い: キーIDにmrk-プレフィックス、リージョン間で透過的に暗号化/復号可能、プライマリ-レプリカ構成。

</details>

### Q9: 暗号化コンテキスト
**Q: KMS暗号化コンテキスト（Encryption Context）の役割は？**

<details><summary>模範解答</summary>

暗号化コンテキストはキー/バリューペアの追加認証データ（AAD）。①暗号化時と復号時に同じコンテキストが必要（一致しないと復号失敗）②CloudTrailログにコンテキストが記録されるため監査に有用 ③条件キー`kms:EncryptionContext`でIAMポリシーに条件を追加可能 ④暗号化されないが暗号文に暗号学的に紐づく。S3ではバケットARNとオブジェクトキーが自動的にコンテキストとして使用される。

</details>

### Q10: インポートキー（BYOK）
**Q: KMSにキーマテリアルをインポートする場合の制約は？**

<details><summary>模範解答</summary>

制約: ①自動ローテーション不可（手動のみ）②リージョン限定（マルチリージョンキーにできない）③キーマテリアルに有効期限を設定可能（設定すると自動削除）④AWSの可用性保証が限定的（元のキーマテリアルの再インポートで復旧可能）⑤対称キーのみサポート ⑥256ビットの対称キーマテリアルが必要。インポート手順: GetParametersForImportでラッピングキーを取得→RSAで暗号化→ImportKeyMaterialで送信。

</details>
