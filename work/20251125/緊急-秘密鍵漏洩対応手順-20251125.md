# 🚨 緊急: 秘密鍵漏洩対応手順

## 📅 作成日
2025-11-25

## ⚠️ 緊急性レベル
**🔴 CRITICAL - 即座の対応が必要**

## 🚨 状況説明

秘密鍵がチャット上で平文共有されました。これは以下のリスクを伴います：

### 重大なリスク
1. **チャットログへの永久記録** - 削除不可能
2. **第三者のアクセス可能性** - チャット履歴が漏洩した場合
3. **不正アクセスのリスク** - この鍵を使った不正ログイン
4. **コンプライアンス違反** - 多くのセキュリティポリシーに抵触

### 影響範囲
- この秘密鍵で認証していたすべてのOCIリソース
- 該当のコンソール接続経由でアクセス可能なインスタンス
- 同じ鍵ペアを使用している他のサービス（あれば）

## ✅ 即座に実行すべき対応手順

### ステップ1: 該当コンソール接続の無効化（最優先）

#### OCIコンソールでの操作
```
1. OCIコンソールにログイン
2. コンピュート → インスタンス
3. 対象インスタンスを選択
4. リソース → コンソール接続
5. 該当のコンソール接続を選択
6. [削除] をクリック
7. 確認ダイアログで [削除] を実行
```

**即座の効果**:
- 漏洩した秘密鍵での認証が不可能になる
- 既存の接続は切断される

### ステップ2: 新しい鍵ペアの生成

```bash
# 1. 新しい鍵ペアを生成（より強固な設定）
ssh-keygen -t rsa -b 4096 -f ~/.ssh/oci_console_new_$(date +%Y%m%d) -C "OCI Console - $(date +%Y-%m-%d)"

# プロンプト例:
# Enter passphrase (empty for no passphrase): [強力なパスフレーズを入力]
# Enter same passphrase again: [再入力]

# 2. 適切なパーミッションを設定
chmod 600 ~/.ssh/oci_console_new_*
chmod 644 ~/.ssh/oci_console_new_*.pub

# 3. 公開鍵の内容を確認
cat ~/.ssh/oci_console_new_*.pub
```

**重要な改善点**:
- **4096ビット鍵** - より強固（2048ビットより推奨）
- **パスフレーズ設定** - 秘密鍵ファイル自体も暗号化
- **日付付き命名** - 管理・識別が容易
- **コメント付与** - 用途が明確

### ステップ3: 新しいコンソール接続の作成

#### OCIコンソールでの操作
```
1. コンピュート → インスタンス
2. 対象インスタンスを選択
3. リソース → コンソール接続
4. [コンソール接続の作成] をクリック
5. 新しい公開鍵を貼り付け
   ↳ ~/.ssh/oci_console_new_*.pub の内容をコピー
6. [コンソール接続の作成] を実行
7. 新しいコンソール接続OCIDをメモ
```

### ステップ4: 新しい鍵での接続テスト

```bash
# 新しい秘密鍵とOCIDを使用
ssh -i ~/.ssh/oci_console_new_20251125 \
    -o ProxyCommand='ssh -i ~/.ssh/oci_console_new_20251125 -W %h:%p -p 443 [新しいコンソール接続OCID]@instance-console.ap-tokyo-1.oci.oraclecloud.com' \
    [インスタンスOCID]

# パスフレーズの入力を求められます
Enter passphrase for key '~/.ssh/oci_console_new_20251125': [パスフレーズ入力]
```

### ステップ5: 古い秘密鍵の完全削除

```bash
# 1. 古い鍵ファイルを特定
ls -la ~/.ssh/ | grep console

# 2. 漏洩した秘密鍵を安全に削除
# ⚠️ 注意: 新しい接続が成功したことを確認してから実行
shred -vfz -n 10 ~/.ssh/[古い秘密鍵ファイル名]

# shredオプション説明:
# -v: 進捗表示
# -f: 強制実行
# -z: 最後にゼロで上書き
# -n 10: 10回ランダム上書き
```

**なぜshredを使うのか**:
- 通常の`rm`コマンドはファイルシステムのリンクを削除するだけ
- データ自体はディスク上に残る可能性がある
- `shred`は物理的にデータを上書きして復元を困難にする

### ステップ6: アクセスログの監査

```bash
# OCIコンソールでアクセスログを確認
# 監査 → ログ → コンピュートサービス
# 対象期間: 秘密鍵漏洩の前後
# 確認項目:
#   - 不審なコンソール接続の試行
#   - 通常と異なる時間帯のアクセス
#   - 通常と異なるソースIPからのアクセス
```

## 🔐 今後のセキュリティベストプラクティス

### 1. 秘密鍵の管理原則

#### ❌ 絶対にやってはいけないこと
```
❌ チャットやメールで秘密鍵を送信
❌ クラウドストレージ（Dropbox, Google Drive等）に保存
❌ バージョン管理システム（Git）にコミット
❌ 複数人で同じ秘密鍵を共有
❌ 平文でバックアップ
❌ パスフレーズなしで鍵を生成
```

#### ✅ 推奨される管理方法
```
✅ ローカルディスクの~/.sshに限定保存
✅ パーミッション600を厳守（chmod 600 ~/.ssh/private_key）
✅ 必ずパスフレーズを設定
✅ 用途別に鍵ペアを分ける
✅ 定期的に鍵をローテーション（3〜6ヶ月ごと）
✅ バックアップは暗号化して保存
```

### 2. パスフレーズの重要性

```bash
# パスフレーズ付き鍵の生成
ssh-keygen -t rsa -b 4096 -f ~/.ssh/secure_key

# パスフレーズは秘密鍵ファイル自体を暗号化
# → ファイルが漏洩してもパスフレーズなしでは使用不可
```

**パスフレーズのベストプラクティス**:
- 最低12文字以上
- 大文字・小文字・数字・記号を混在
- 辞書にない単語の組み合わせ
- パスワードマネージャーで管理

### 3. ssh-agentの活用

```bash
# ssh-agentで鍵を管理（パスフレーズ入力を1回のみに）
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/oci_console_new_20251125

# セッション中は再入力不要
# ログアウト時に自動削除
```

### 4. SSHconfig設定例（セキュア版）

```bash
# ~/.ssh/config
Host oci-console-tokyo
    User [インスタンスOCID]
    IdentityFile ~/.ssh/oci_console_new_20251125
    ProxyCommand ssh -i ~/.ssh/oci_console_new_20251125 -W %h:%p -p 443 [コンソール接続OCID]@instance-console.ap-tokyo-1.oci.oraclecloud.com
    ServerAliveInterval 60
    ServerAliveCountMax 3
    # セキュリティ強化オプション
    StrictHostKeyChecking ask
    VerifyHostKeyDNS yes
    ForwardAgent no
    ForwardX11 no

# パーミッション設定
chmod 600 ~/.ssh/config
```

### 5. 鍵のローテーション計画

```
推奨ローテーションスケジュール:
┌─────────────┬──────────────────┐
│ 環境        │ ローテーション頻度 │
├─────────────┼──────────────────┤
│ 本番環境    │ 3ヶ月ごと        │
│ ステージング│ 6ヶ月ごと        │
│ 開発環境    │ 6ヶ月ごと        │
│ 個人環境    │ 年1回            │
└─────────────┴──────────────────┘

インシデント発生時: 即座にローテーション
```

## 📊 漏洩時の影響範囲チェックリスト

### 確認すべき項目
- [ ] 該当の秘密鍵で認証していたサービスをすべてリストアップ
- [ ] 各サービスのアクセスログを確認
- [ ] 不審なアクセスがないか監査
- [ ] 同じ鍵を使用している他のOCIリソースを確認
- [ ] チームメンバーへの通知（該当する場合）
- [ ] セキュリティインシデントレポートの作成（組織要件に応じて）
- [ ] 再発防止策の文書化

## 🎓 学習ポイント

### なぜ秘密鍵は秘密にすべきか

```
秘密鍵 = 家の鍵
公開鍵 = 家の鍵穴

秘密鍵を共有する = 家の鍵を他人に渡す
→ 誰でもあなたの家（サーバー）に入れる状態
```

### 公開鍵暗号の仕組み
```
公開鍵で暗号化 → 秘密鍵でのみ復号可能
秘密鍵で署名   → 公開鍵で署名検証可能

秘密鍵を持つ = 本人であることの証明
秘密鍵の漏洩 = なりすましが可能に
```

## 📚 参考リソース

### OCI公式ドキュメント
- [セキュリティベストプラクティス](https://docs.oracle.com/en-us/iaas/Content/Security/Reference/iam_security.htm)
- [SSH鍵の管理](https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/managingkeypairs.htm)

### SSH鍵管理ガイド
- [OpenSSH公式: ssh-keygen](https://www.openssh.com/manual.html)
- [NIST推奨: 暗号鍵管理](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)

## 🎯 今後の予防策

### 1. 鍵管理ポリシーの策定
```markdown
# 組織の鍵管理ポリシー例
1. すべての秘密鍵にパスフレーズを設定
2. 鍵は~/.ssh以外に保存しない
3. 定期的なローテーション（3ヶ月ごと）
4. 退職時は即座に無効化
5. インシデント発生時の対応フロー整備
```

### 2. セキュリティトレーニング
- 秘密鍵の取り扱いに関する社内研修
- インシデント対応手順の定期的な見直し
- セキュリティ意識の向上

### 3. 技術的な保護策
```bash
# ssh-agentのタイムアウト設定
ssh-add -t 3600 ~/.ssh/key  # 1時間で自動削除

# GPG暗号化でバックアップ
gpg --symmetric --cipher-algo AES256 ~/.ssh/private_key

# YubiKeyなどのハードウェアトークン使用
```

## 💡 まとめ

### 今回の教訓
```
❌ 秘密鍵は「秘密」に保つべき最重要情報
❌ チャットやメールでの共有は絶対に避ける
✅ 漏洩時は即座の無効化と再生成が必須
✅ パスフレーズ付き鍵の使用でリスク軽減
✅ 定期的なローテーションで長期的なリスク低減
```

### 即座のアクション
1. **今すぐ**: 漏洩したコンソール接続を削除
2. **今すぐ**: 新しいパスフレーズ付き鍵ペアを生成
3. **今すぐ**: 新しいコンソール接続を作成
4. **今日中**: アクセスログの監査
5. **今週中**: 他のサービスの鍵管理見直し

---

**🚨 この対応は緊急を要します。可能な限り早急に実施してください。**
