# OCI インスタンスコンソール接続エラー - 公開鍵認証失敗

## 📅 作成日
2025-11-25

## ❌ エラー内容
```bash
Permission denied (publickey).
Connection closed by UNKNOWN port 65535
```

## 🔍 原因分析

### 主な原因
このエラーは **SSH公開鍵認証の失敗** によるものです。OCIのインスタンスコンソール接続は、事前に登録した公開鍵に対応する秘密鍵を使用して認証を行います。

### 具体的な原因候補

#### 1. **秘密鍵が指定されていない（最も可能性が高い）**
```bash
# 現在のコマンド
ssh -o ProxyCommand='ssh -W %h:%p -p 443 ocid1.instanceconsole...' ocid1.instance...

# ✅ 正しいコマンド（秘密鍵を明示指定）
ssh -i ~/.ssh/console_key -o ProxyCommand='ssh -i ~/.ssh/console_key -W %h:%p -p 443 ocid1.instanceconsole...' ocid1.instance...
```

**重要**: `-i` オプションで秘密鍵を **2箇所** に指定する必要があります：
- ProxyCommand内（コンソール接続認証用）
- メインのsshコマンド（インスタンス認証用）

#### 2. **コンソール接続作成時の公開鍵とローカルの秘密鍵が不一致**
- インスタンスコンソール接続を作成した際に使用した公開鍵と、現在ローカルにある秘密鍵が対になっていない
- 別の端末で作成した鍵ペアを使用している

#### 3. **秘密鍵ファイルのパーミッションが不適切**
```bash
# ❌ 不適切な例
-rw-r--r-- 1 user user console_key  # 644 (他者が読める)

# ✅ 適切な設定
-rw------- 1 user user console_key  # 600 (所有者のみ)
```

#### 4. **秘密鍵ファイルのパスが間違っている**
- デフォルトの `~/.ssh/id_rsa` とは別の鍵を使用している場合、明示的に指定が必要

#### 5. **ssh-agentに鍵が登録されていない**
- ssh-agentを使用している場合、該当の秘密鍵が登録されていない可能性

## ✅ 解決手順

### ステップ1: 使用している公開鍵の確認

OCIコンソールで確認：
```
コンピュート → インスタンス → リソース → コンソール接続
→ 該当のコンソール接続を選択 → 公開鍵の内容を確認
```

### ステップ2: ローカルの秘密鍵を確認

```bash
# 秘密鍵の一覧確認
ls -la ~/.ssh/

# 公開鍵から秘密鍵を特定（フィンガープリント比較）
ssh-keygen -lf ~/.ssh/console_key.pub
ssh-keygen -lf ~/.ssh/id_rsa.pub
```

### ステップ3: 秘密鍵のパーミッション修正

```bash
# 秘密鍵のパーミッションを600に設定
chmod 600 ~/.ssh/console_key

# 確認
ls -l ~/.ssh/console_key
```

### ステップ4: 秘密鍵を明示的に指定して接続

```bash
# 方法1: -i オプションで明示指定（推奨）
ssh -i ~/.ssh/console_key \
    -o ProxyCommand='ssh -i ~/.ssh/console_key -W %h:%p -p 443 ocid1.instanceconsoleconnection.oc1.ap-tokyo-1.anxhiljrtc2ci5ac3xvxpnpdtxl3h4atdwcswf7w3a4kp5c2qkachqbtnzfq@instance-console.ap-tokyo-1.oci.oraclecloud.com' \
    ocid1.instance.oc1.ap-tokyo-1.anxhiljrtc2ci5acbpj3zsrtxhkng5qabyauegqk42rehbwqyu3xnrhpjt2a

# 方法2: 詳細なデバッグ情報を出力
ssh -vvv -i ~/.ssh/console_key \
    -o ProxyCommand='ssh -vvv -i ~/.ssh/console_key -W %h:%p -p 443 ocid1.instanceconsoleconnection.oc1.ap-tokyo-1.anxhiljrtc2ci5ac3xvxpnpdtxl3h4atdwcswf7w3a4kp5c2qkachqbtnzfq@instance-console.ap-tokyo-1.oci.oraclecloud.com' \
    ocid1.instance.oc1.ap-tokyo-1.anxhiljrtc2ci5acbpj3zsrtxhkng5qabyauegqk42rehbwqyu3xnrhpjt2a
```

### ステップ5: 新しいコンソール接続を作成（最終手段）

現在の鍵ペアが見つからない場合：

```bash
# 1. 新しい鍵ペアを生成
ssh-keygen -t rsa -b 4096 -f ~/.ssh/oci_console_key

# 2. 公開鍵の内容をコピー
cat ~/.ssh/oci_console_key.pub

# 3. OCIコンソールで新しいコンソール接続を作成
#    - 既存のコンソール接続を削除（オプション）
#    - 新しいコンソール接続を作成し、上記の公開鍵を貼り付け

# 4. 新しいOCID（コンソール接続OCID）を使用して接続
ssh -i ~/.ssh/oci_console_key \
    -o ProxyCommand='ssh -i ~/.ssh/oci_console_key -W %h:%p -p 443 <新しいコンソール接続OCID>@instance-console.ap-tokyo-1.oci.oraclecloud.com' \
    <インスタンスOCID>
```

## 🔐 セキュリティベストプラクティス

### 秘密鍵の管理
```bash
# ✅ 推奨パーミッション
chmod 600 ~/.ssh/private_key     # 秘密鍵
chmod 644 ~/.ssh/public_key.pub  # 公開鍵

# ✅ ディレクトリパーミッション
chmod 700 ~/.ssh
```

### 鍵の命名規則
```bash
# 用途別に鍵を分けて管理
~/.ssh/oci_console_key          # OCIコンソール接続用
~/.ssh/oci_instance_key         # OCI通常SSH接続用
~/.ssh/id_rsa                   # 汎用鍵（デフォルト）
```

### SSHconfig設定（推奨）

`~/.ssh/config` に設定を追加すると簡単に接続できます：

```bash
# ~/.ssh/config
Host oci-console
    User ocid1.instance.oc1.ap-tokyo-1.anxhiljrtc2ci5acbpj3zsrtxhkng5qabyauegqk42rehbwqyu3xnrhpjt2a
    IdentityFile ~/.ssh/console_key
    ProxyCommand ssh -i ~/.ssh/console_key -W %h:%p -p 443 ocid1.instanceconsoleconnection.oc1.ap-tokyo-1.anxhiljrtc2ci5ac3xvxpnpdtxl3h4atdwcswf7w3a4kp5c2qkachqbtnzfq@instance-console.ap-tokyo-1.oci.oraclecloud.com

# 接続コマンドがシンプルに
ssh oci-console
```

## 🧪 動作確認チェックリスト

- [ ] 秘密鍵ファイルが存在する（`ls -la ~/.ssh/`）
- [ ] 秘密鍵のパーミッションが600または400
- [ ] 公開鍵がOCIコンソール接続に登録されている
- [ ] 秘密鍵と公開鍵のフィンガープリントが一致する
- [ ] `-i` オプションでProxyCommandとメインコマンドの両方に秘密鍵を指定
- [ ] OCIDが正しい（コンソール接続OCID、インスタンスOCID）
- [ ] `-vvv` オプションで詳細ログを確認済み

## 📚 参考リンク

### OCI公式ドキュメント
- [インスタンスへの接続](https://docs.cloud.oracle.com/iaas/Content/Compute/Tasks/accessinginstance.htm)
- [シリアルコンソールのトラブルシューティング](https://docs.cloud.oracle.com/en-us/iaas/Content/Compute/References/serialconsole.htm#four)

### SSH認証のデバッグ
```bash
# 詳細ログで認証プロセスを確認
ssh -vvv ...
```

重要な確認ポイント：
- `debug1: Trying private key: /home/user/.ssh/...` - どの鍵を試しているか
- `debug1: Authentications that can continue: publickey` - サーバー側が求める認証方式
- `debug1: No more authentication methods to try` - すべての鍵が失敗

## 💡 よくある誤解

### ❌ 誤り: 通常のSSH接続と同じ鍵を使える
→ ✅ 正解: コンソール接続専用の鍵ペアを登録する必要がある

### ❌ 誤り: -i オプションは1箇所だけ指定すればよい
→ ✅ 正解: ProxyCommandとメインコマンドの両方に指定が必要

### ❌ 誤り: ssh-agentに登録していれば自動で使われる
→ ✅ 正解: コンソール接続では明示的な指定が推奨される

## 🎯 まとめ

このエラーの最も一般的な原因は **秘密鍵の未指定** です。

**即座に試すべきコマンド**:
```bash
# コンソール接続作成時に使用した秘密鍵を明示指定
ssh -i ~/.ssh/あなたの秘密鍵 \
    -o ProxyCommand='ssh -i ~/.ssh/あなたの秘密鍵 -W %h:%p -p 443 <コンソール接続OCID>@instance-console.ap-tokyo-1.oci.oraclecloud.com' \
    <インスタンスOCID>
```

それでも解決しない場合は、新しい鍵ペアを生成して新しいコンソール接続を作成してください。
