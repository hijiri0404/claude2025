# DNS レコード登録 注意事項とTIPS（簡潔版）

## 1. メール送信時の必須設定

### SPF/DKIM/DMARC は必須
- メール認証レコード未設定だとスパム判定される
- SPF：送信サーバーのIPアドレスを明示（TXTレコード）
- DKIM：メールに電子署名を付与（TXTレコード）
- DMARC：認証失敗時の処理ポリシーを定義（TXTレコード）
- 段階的運用：p=none → p=quarantine → p=reject

---

## 2. CNAMEレコードの2つの制約

### ❌ Zone Apex に設定不可
- `example.com` のような頂点ドメインにCNAMEは使えない
- DNS仕様（RFC）上の制約

### ❌ 他レコードと共存不可
- 同じ名前でCNAMEと他レコード（A、MX、TXT等）は共存できない
- メール（MX）とWeb（CNAME）は別ドメイン/サブドメインに分離必要

### ✅ 解決策：AWS Aliasレコード
- Zone Apexにも設定可能
- 他レコードタイプと共存可能
- クエリ料金無料

---

## 3. TTL（Time To Live）設定

### 環境別推奨値
- 本番環境：86400秒（24時間）
- 移行期間：300-900秒（5-15分）
- 開発環境：60-300秒（1-5分）

### 変更時の手順
1. 変更24-48時間前にTTLを短縮（300秒）
2. DNS変更実施
3. 旧TTL期間待機
4. TTLを元に戻す

---

## 4. MXレコードの優先度

### 複数サーバー設定
- 小さい数値 = 高優先度
- 例：MX 10（プライマリ）、MX 20（セカンダリ）
- 同じ優先度で負荷分散（ラウンドロビン）
- ターゲットはホスト名で指定（IPアドレス不可）

---

## 5. CAA（証明書発行制御）

### SSL/TLS証明書の不正発行防止
- 許可する認証局（CA）を明示的に指定
- AWS ACM利用時：amazon.com、amazonaws.com等を許可
- CAAとCNAMEは共存不可

**設定例**：
```
example.com. CAA 0 issue "amazon.com"
```

---

## 6. ワイルドカードレコード

### 用途と注意
- `*.example.com` で未定義サブドメインをカバー
- 1階層のみマッチ（2階層以上は不可）
- より具体的なレコードが優先
- セキュリティリスク：意図しないサブドメインもマッチ

---

## 7. IPv6対応（AAAAレコード）

### デュアルスタック構成推奨
- Aレコード（IPv4）とAAAAレコード（IPv6）両方設定
- IPv4のみ：IPv6ユーザーがアクセス不可
- IPv6のみ：IPv4ユーザーがアクセス不可

---

## 8. TXTレコードの長さ制限

### 255文字制限の対処
- 1つの値は255文字まで
- 超過時は複数文字列に分割して記述
- 用途：SPF、DKIM、ドメイン所有権確認

---

## 9. DNSプロパゲーション時間

### 変更反映までの待機
- TTLに応じて段階的に世界中へ伝播
- 確認方法：`dig @8.8.8.8 example.com`
- Webツール：whatsmydns.net、dnschecker.org
- 重要変更前は事前にTTL短縮

---

## 10. 検証コマンド

### 基本確認
```bash
dig example.com           # 基本的な名前解決
dig example.com MX        # MXレコード確認
dig example.com TXT       # TXTレコード確認
dig +trace example.com    # ルートDNSからトレース
dig _dmarc.example.com TXT # DMARCレコード確認
```

---

## よくあるトラブルと対処

| 問題 | 原因 | 対処法 |
|------|------|--------|
| メール不達 | SPF/DKIM/DMARC未設定 | 認証レコード設定 |
| Zone Apex CNAME不可 | DNS仕様制約 | Aliasレコード使用 |
| 変更未反映 | TTLキャッシュ | TTL期間待機 |
| SSL証明書不可 | CAA制限 | CAAレコード確認 |

---

## 設定前チェックリスト

### メール送信システム
- [ ] SPFレコード設定済み
- [ ] DKIMレコード設定済み
- [ ] DMARCレコード設定済み

### CNAME関連
- [ ] Zone ApexにCNAME未設定
- [ ] CNAMEと他レコードが共存していない
- [ ] AWS利用時はAlias検討

### 基本設定
- [ ] TTL値が適切
- [ ] 変更前のバックアップ取得
- [ ] 検証手順準備済み

---

## 11. NSレコードとサブドメイン委任

### DNS管理の分離
- NSレコードで特定サブドメインを別ホストゾーンへ委任可能
- 組織/部門ごとの独立DNS管理を実現
- 委任後は全レコード（Zone Apex含む）が委任先で管理
- 親ゾーンにはNSレコードのみ配置

**活用例**：
```
example.com         → IT部門が管理
dev.example.com     → 開発部門が独立管理（委任）
prod.example.com    → 本番運用チームが独立管理（委任）
```

---

## 12. SRVレコード（サービスレコード）

### 特定サービスの位置情報
- サービスのホスト名とポート番号を指定
- 主な用途：SIP、XMPP、LDAP、Minecraft等
- 優先度・重み・ポート・ターゲットの4要素で構成
- 同一サービスで複数サーバーの負荷分散可能

**設定例**：
```
_sip._tcp.example.com. SRV 10 60 5060 sipserver.example.com.
```

---

## 13. PTRレコード（逆引きDNS）

### IPアドレスから名前解決
- メールサーバーの信頼性向上に必須
- 逆引き未設定だとメール拒否される可能性
- ISP/クラウド事業者に設定依頼が必要な場合あり
- 正引き（A/AAAA）と逆引き（PTR）の一致確認推奨

**確認方法**：
```bash
dig -x 192.0.2.1    # IPv4逆引き
dig -x 2001:db8::1  # IPv6逆引き
```

---

## 14. SOAレコードの管理

### ゾーン情報の要
- 各ホストゾーンに必ず1つ存在（自動生成）
- プライマリネームサーバー、管理者メール、シリアル番号等を記録
- リフレッシュ間隔、リトライ間隔、有効期限を定義
- Route53では自動管理されるため手動編集不要

**重要パラメータ**：
- Serial：ゾーンファイル更新ごとに増加
- Refresh：セカンダリサーバーの更新間隔
- Retry：失敗時の再試行間隔

---

## 15. DNSSEC（DNS Security Extensions）

### DNS応答の改ざん防止
- デジタル署名でDNS応答の真正性を保証
- キャッシュポイズニング攻撃を防止
- Route53では簡単に有効化可能
- 設定後は鍵のローテーション管理が必要

**有効化のメリット**：
- DNS応答の完全性保証
- 中間者攻撃（MITM）の防止
- 金融・医療等の高セキュリティ要件に対応

---

## 16. GeoDNS/位置情報ルーティング

### ユーザー位置に応じた応答
- リクエスト元の地理的位置で異なるIPを返す
- グローバルサービスのレイテンシ削減
- 地域別コンプライアンス対応
- Route53の地理的位置情報ルーティング活用

**活用例**：
- 米国ユーザー → us-server.example.com
- 欧州ユーザー → eu-server.example.com
- アジアユーザー → ap-server.example.com

---

## 17. ヘルスチェックとフェイルオーバー

### 自動障害対応
- Route53ヘルスチェックで死活監視
- 障害検知時に自動的にバックアップへ切替
- HTTP/HTTPS/TCP/計算ヘルスチェック対応
- 複数リージョン構成での高可用性実現

**設定項目**：
- チェック間隔：10秒 or 30秒
- 失敗しきい値：通常3回連続失敗
- アラーム連携：CloudWatch/SNS通知

---

## 18. DNSクエリログ/監査

### セキュリティとトラブルシューティング
- Route53クエリログでDNS問い合わせを記録
- CloudWatch Logsへ出力して分析可能
- 不審なクエリパターンの検出
- コンプライアンス監査証跡として活用

**分析項目**：
- クエリ元IPアドレス
- 問い合わせドメイン名
- レスポンスコード
- クエリタイプ（A、AAAA、MX等）

---

## 19. レート制限とDDoS対策

### DNS amplification攻撃の防御
- 大量クエリによるDNS増幅攻撃に注意
- Route53は自動的にDDoS対策実施
- AWS Shieldによる追加保護
- 異常なクエリパターンの監視

**ベストプラクティス**：
- 不要なワイルドカードレコード削除
- ANY クエリタイプの応答最小化
- DNSSECによる応答サイズ最適化

---

## 20. マルチクラウド/ハイブリッドDNS

### 複数環境の統合管理
- オンプレミスとクラウドの名前解決統合
- Route53 ResolverでVPC-オンプレ間DNS転送
- プライベートホストゾーンとパブリックの使い分け
- 条件付きフォワーディングで柔軟なルーティング

**構成例**：
- パブリックDNS：Route53でグローバル公開
- プライベートDNS：VPC内部でのみ解決
- ハイブリッド：オンプレADとの統合

---

## 追加：よくある応用トラブルと対処

| 問題 | 原因 | 対処法 |
|------|------|--------|
| メール逆引き不可 | PTRレコード未設定 | ISP/クラウド事業者へ設定依頼 |
| サブドメイン委任失敗 | NSレコード不正 | 全ネームサーバー正確に指定 |
| 特定サービス接続不可 | SRVレコード欠如 | プロトコル・ポート含め正確設定 |
| DNS増幅攻撃 | オープンリゾルバ | 不要なワイルドカード削除 |

---

## 追加：高度な設定チェックリスト

### セキュリティ強化
- [ ] DNSSEC有効化済み
- [ ] DNSクエリログ記録中
- [ ] DDoS対策確認済み

### 高可用性
- [ ] ヘルスチェック設定済み
- [ ] フェイルオーバー構成済み
- [ ] マルチリージョン展開検討

### パフォーマンス
- [ ] GeoDNS活用検討
- [ ] レイテンシベースルーティング検討
- [ ] IPv6デュアルスタック構成

### 管理・運用
- [ ] サブドメイン委任による権限分離
- [ ] PTRレコード（逆引き）設定済み
- [ ] クエリログの定期監査体制
