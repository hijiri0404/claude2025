# DNS レコード登録 注意事項とTIPS（簡潔版）

## 1. メール送信時の必須設定

### SPF/DKIM/DMARC は必須
- メール認証レコード未設定だとスパム判定される
- SPF：送信サーバーのIPアドレスを明示（TXTレコード）
- DKIM：メールに電子署名を付与（TXTレコード）
- DMARC：認証失敗時の処理ポリシーを定義（TXTレコード）
- 段階的運用：p=none → p=quarantine → p=reject

---

## 2. CNAMEレコードの2つの制約

### ❌ Zone Apex に設定不可
- `example.com` のような頂点ドメインにCNAMEは使えない
- DNS仕様（RFC）上の制約

### ❌ 他レコードと共存不可
- 同じ名前でCNAMEと他レコード（A、MX、TXT等）は共存できない
- メール（MX）とWeb（CNAME）は別ドメイン/サブドメインに分離必要

### ✅ 解決策：AWS Aliasレコード
- Zone Apexにも設定可能
- 他レコードタイプと共存可能
- クエリ料金無料

---

## 3. TTL（Time To Live）設定

### 環境別推奨値
- 本番環境：86400秒（24時間）
- 移行期間：300-900秒（5-15分）
- 開発環境：60-300秒（1-5分）

### 変更時の手順
1. 変更24-48時間前にTTLを短縮（300秒）
2. DNS変更実施
3. 旧TTL期間待機
4. TTLを元に戻す

---

## 4. MXレコードの優先度

### 複数サーバー設定
- 小さい数値 = 高優先度
- 例：MX 10（プライマリ）、MX 20（セカンダリ）
- 同じ優先度で負荷分散（ラウンドロビン）
- ターゲットはホスト名で指定（IPアドレス不可）

---

## 5. CAA（証明書発行制御）

### SSL/TLS証明書の不正発行防止
- 許可する認証局（CA）を明示的に指定
- AWS ACM利用時：amazon.com、amazonaws.com等を許可
- CAAとCNAMEは共存不可

**設定例**：
```
example.com. CAA 0 issue "amazon.com"
```

---

## 6. ワイルドカードレコード

### 用途と注意
- `*.example.com` で未定義サブドメインをカバー
- 1階層のみマッチ（2階層以上は不可）
- より具体的なレコードが優先
- セキュリティリスク：意図しないサブドメインもマッチ

---

## 7. IPv6対応（AAAAレコード）

### デュアルスタック構成推奨
- Aレコード（IPv4）とAAAAレコード（IPv6）両方設定
- IPv4のみ：IPv6ユーザーがアクセス不可
- IPv6のみ：IPv4ユーザーがアクセス不可

---

## 8. TXTレコードの長さ制限

### 255文字制限の対処
- 1つの値は255文字まで
- 超過時は複数文字列に分割して記述
- 用途：SPF、DKIM、ドメイン所有権確認

---

## 9. DNSプロパゲーション時間

### 変更反映までの待機
- TTLに応じて段階的に世界中へ伝播
- 確認方法：`dig @8.8.8.8 example.com`
- Webツール：whatsmydns.net、dnschecker.org
- 重要変更前は事前にTTL短縮

---

## 10. 検証コマンド

### 基本確認
```bash
dig example.com           # 基本的な名前解決
dig example.com MX        # MXレコード確認
dig example.com TXT       # TXTレコード確認
dig +trace example.com    # ルートDNSからトレース
dig _dmarc.example.com TXT # DMARCレコード確認
```

---

## よくあるトラブルと対処

| 問題 | 原因 | 対処法 |
|------|------|--------|
| メール不達 | SPF/DKIM/DMARC未設定 | 認証レコード設定 |
| Zone Apex CNAME不可 | DNS仕様制約 | Aliasレコード使用 |
| 変更未反映 | TTLキャッシュ | TTL期間待機 |
| SSL証明書不可 | CAA制限 | CAAレコード確認 |

---

## 設定前チェックリスト

### メール送信システム
- [ ] SPFレコード設定済み
- [ ] DKIMレコード設定済み
- [ ] DMARCレコード設定済み

### CNAME関連
- [ ] Zone ApexにCNAME未設定
- [ ] CNAMEと他レコードが共存していない
- [ ] AWS利用時はAlias検討

### 基本設定
- [ ] TTL値が適切
- [ ] 変更前のバックアップ取得
- [ ] 検証手順準備済み
